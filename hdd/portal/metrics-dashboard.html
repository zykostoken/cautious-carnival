<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©tricas por Paciente - HDD | Cl√≠nica Jos√© Ingenieros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 24px;
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid #333;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">üìä Dashboard de M√©tricas Individuales</h1>
                <p class="text-gray-600 mt-2">Hospital de D√≠a - Cl√≠nica Jos√© Ingenieros</p>
            </div>
            <a href="/hdd/portal" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition">
                ‚Üê Volver al Portal
            </a>
        </div>
    </div>

    <!-- Patient Selector -->
    <div class="metric-card">
        <label class="block text-lg font-semibold text-gray-700 mb-3">Seleccionar Paciente</label>
        <select id="patient-selector" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg">
            <option value="">Cargando pacientes...</option>
        </select>
    </div>

    <!-- Stats Overview -->
    <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden">
        <div class="stat-box">
            <div class="stat-value" id="stat-total-sessions">-</div>
            <div class="stat-label">Sesiones Totales</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-most-played">-</div>
            <div class="stat-label">Juego Favorito</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-most-color">-</div>
            <div class="stat-label">Color Frecuente</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-avg-duration">-</div>
            <div class="stat-label">Duraci√≥n Promedio</div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- Mood Timeline Chart -->
        <div class="metric-card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìà Intensidad Emocional (Timeline)</h2>
            <canvas id="mood-timeline-chart"></canvas>
        </div>

        <!-- Color Frequency Chart -->
        <div class="metric-card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üé® Colores Seleccionados (Frecuencia)</h2>
            <canvas id="color-frequency-chart"></canvas>
        </div>

    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- Game Performance Chart -->
        <div class="metric-card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üéÆ Rendimiento por Juego</h2>
            <canvas id="game-performance-chart"></canvas>
        </div>

        <!-- Intensity Distribution -->
        <div class="metric-card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">‚ö° Distribuci√≥n de Intensidades</h2>
            <canvas id="intensity-distribution-chart"></canvas>
        </div>

    </div>

    <!-- Sessions Table -->
    <div class="metric-card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">üìã Historial de Sesiones</h2>
            <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                üì• Exportar CSV
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full" id="sessions-table">
                <thead>
                    <tr class="bg-gray-100 text-left">
                        <th class="px-4 py-3 rounded-tl-lg">Fecha</th>
                        <th class="px-4 py-3">Juego</th>
                        <th class="px-4 py-3">Intensidad</th>
                        <th class="px-4 py-3">Color</th>
                        <th class="px-4 py-3">Duraci√≥n</th>
                        <th class="px-4 py-3 rounded-tr-lg">Tags Psicol√≥gicos</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Seleccione un paciente</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
// Supabase client
const supabaseUrl = 'https://yqpqfzvgcmvxvqzvtajx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcHFmenZnY212eHZxenZ0YWp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4NTczODUsImV4cCI6MjA1NDQzMzM4NX0.iSEbjuVqIWFTlUgvPYJCdl75jlFqNkITCKk5C-gqiDI';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let currentPatientId = null;
let charts = {};
let sessionsData = [];

// ============================================================================
// LOAD PATIENTS
// ============================================================================

async function loadPatients() {
    try {
        const { data, error } = await supabase
            .from('hdd_patients')
            .select('id, full_name, dni, status')
            .eq('status', 'active')
            .order('full_name');
        
        if (error) throw error;
        
        const selector = document.getElementById('patient-selector');
        selector.innerHTML = '<option value="">-- Seleccionar paciente --</option>';
        
        data.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient.id;
            option.textContent = `${patient.full_name} (DNI: ${patient.dni})`;
            selector.appendChild(option);
        });
        
        console.log('‚úÖ Loaded', data.length, 'patients');
    } catch (error) {
        console.error('‚ùå Error loading patients:', error);
        alert('Error al cargar pacientes');
    }
}

// ============================================================================
// LOAD PATIENT METRICS
// ============================================================================

async function loadPatientMetrics(patientId) {
    if (!patientId) {
        document.getElementById('stats-overview').classList.add('hidden');
        return;
    }
    
    currentPatientId = patientId;
    
    try {
        // Load sessions from v_hdd_session_analysis
        const { data: sessions, error } = await supabase
            .from('v_hdd_session_analysis')
            .select('*')
            .eq('patient_id', patientId)
            .order('completed_at', { ascending: false });
        
        if (error) throw error;
        
        sessionsData = sessions;
        
        // Update stats
        updateStats(sessions);
        
        // Update charts
        updateMoodTimeline(sessions);
        updateColorFrequency(sessions);
        updateGamePerformance(sessions);
        updateIntensityDistribution(sessions);
        
        // Update table
        updateSessionsTable(sessions);
        
        document.getElementById('stats-overview').classList.remove('hidden');
        
        console.log('‚úÖ Loaded', sessions.length, 'sessions for patient', patientId);
    } catch (error) {
        console.error('‚ùå Error loading metrics:', error);
        alert('Error al cargar m√©tricas');
    }
}

// ============================================================================
// UPDATE STATS
// ============================================================================

function updateStats(sessions) {
    document.getElementById('stat-total-sessions').textContent = sessions.length;
    
    // Most played game
    const gameCounts = {};
    sessions.forEach(s => {
        gameCounts[s.game_type] = (gameCounts[s.game_type] || 0) + 1;
    });
    const mostPlayed = Object.keys(gameCounts).reduce((a, b) => 
        gameCounts[a] > gameCounts[b] ? a : b, 'N/A');
    document.getElementById('stat-most-played').textContent = 
        mostPlayed.replace('_', ' ').replace('pill', 'Pill').replace('lawn', 'Lawn').replace('medication', 'Med');
    
    // Most frequent color
    const colorCounts = {};
    sessions.forEach(s => {
        if (s.color_family) {
            colorCounts[s.color_family] = (colorCounts[s.color_family] || 0) + 1;
        }
    });
    const mostColor = Object.keys(colorCounts).reduce((a, b) => 
        colorCounts[a] > colorCounts[b] ? a : b, 'N/A');
    document.getElementById('stat-most-color').textContent = mostColor;
    
    // Average duration
    const avgDuration = sessions.reduce((sum, s) => sum + (s.session_duration_seconds || 0), 0) / sessions.length;
    document.getElementById('stat-avg-duration').textContent = 
        Math.round(avgDuration / 60) + ' min';
}

// ============================================================================
// UPDATE CHARTS
// ============================================================================

function updateMoodTimeline(sessions) {
    const ctx = document.getElementById('mood-timeline-chart');
    
    if (charts.moodTimeline) charts.moodTimeline.destroy();
    
    const labels = sessions.slice().reverse().map(s => 
        new Date(s.completed_at).toLocaleDateString('es-AR')
    );
    
    const intensityValues = sessions.slice().reverse().map(s => {
        const intensityMap = { vivid: 5, soft: 4, pastel: 3, dark: 2, muted: 1 };
        return intensityMap[s.post_intensity] || 0;
    });
    
    charts.moodTimeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Intensidad Emocional',
                data: intensityValues,
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { min: 0, max: 5, ticks: { stepSize: 1 } }
            }
        }
    });
}

function updateColorFrequency(sessions) {
    const ctx = document.getElementById('color-frequency-chart');
    
    if (charts.colorFrequency) charts.colorFrequency.destroy();
    
    const colorCounts = {};
    sessions.forEach(s => {
        if (s.post_color_hex) {
            colorCounts[s.post_color_hex] = (colorCounts[s.post_color_hex] || 0) + 1;
        }
    });
    
    const colors = Object.keys(colorCounts);
    const counts = Object.values(colorCounts);
    
    charts.colorFrequency = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: colors,
            datasets: [{
                label: 'Frecuencia',
                data: counts,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function updateGamePerformance(sessions) {
    const ctx = document.getElementById('game-performance-chart');
    
    if (charts.gamePerformance) charts.gamePerformance.destroy();
    
    const gameData = {};
    sessions.forEach(s => {
        if (!gameData[s.game_type]) gameData[s.game_type] = [];
        gameData[s.game_type].push(s.session_duration_seconds / 60);
    });
    
    const datasets = Object.keys(gameData).map((game, i) => ({
        label: game.replace('_', ' '),
        data: [gameData[game].reduce((a, b) => a + b, 0) / gameData[game].length],
        backgroundColor: ['#667eea', '#764ba2', '#f093fb'][i]
    }));
    
    charts.gamePerformance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Duraci√≥n Promedio (min)'],
            datasets: datasets
        },
        options: { responsive: true }
    });
}

function updateIntensityDistribution(sessions) {
    const ctx = document.getElementById('intensity-distribution-chart');
    
    if (charts.intensityDist) charts.intensityDist.destroy();
    
    const intensityCounts = { vivid: 0, soft: 0, pastel: 0, dark: 0, muted: 0 };
    sessions.forEach(s => {
        if (s.post_intensity) intensityCounts[s.post_intensity]++;
    });
    
    charts.intensityDist = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(intensityCounts),
            datasets: [{
                data: Object.values(intensityCounts),
                backgroundColor: ['#ff6b6b', '#4ecdc4', '#ffd3b6', '#2d3436', '#95a5a6']
            }]
        },
        options: { responsive: true }
    });
}

// ============================================================================
// UPDATE TABLE
// ============================================================================

function updateSessionsTable(sessions) {
    const tbody = document.getElementById('sessions-tbody');
    tbody.innerHTML = '';
    
    sessions.forEach(session => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3">${new Date(session.completed_at).toLocaleString('es-AR')}</td>
            <td class="px-4 py-3">${session.game_type.replace('_', ' ')}</td>
            <td class="px-4 py-3">${session.post_intensity || 'N/A'}</td>
            <td class="px-4 py-3">
                ${session.post_color_hex ? 
                    `<span class="color-dot" style="background: ${session.post_color_hex}"></span>${session.post_color_hex}` 
                    : 'N/A'}
            </td>
            <td class="px-4 py-3">${Math.round(session.session_duration_seconds / 60)} min</td>
            <td class="px-4 py-3 text-sm">${session.psychological_tags ? session.psychological_tags.join(', ') : 'N/A'}</td>
        `;
        tbody.appendChild(row);
    });
}

// ============================================================================
// EXPORT TO CSV
// ============================================================================

function exportToCSV() {
    if (!sessionsData.length) {
        alert('No hay datos para exportar');
        return;
    }
    
    const csv = [
        ['Fecha', 'Juego', 'Intensidad', 'Color', 'Duraci√≥n (min)', 'Tags Psicol√≥gicos'].join(','),
        ...sessionsData.map(s => [
            new Date(s.completed_at).toLocaleString('es-AR'),
            s.game_type,
            s.post_intensity || '',
            s.post_color_hex || '',
            Math.round(s.session_duration_seconds / 60),
            (s.psychological_tags || []).join('; ')
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `metricas_paciente_${currentPatientId}_${Date.now()}.csv`;
    a.click();
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================

document.getElementById('patient-selector').addEventListener('change', (e) => {
    loadPatientMetrics(e.target.value);
});

// ============================================================================
// INIT
// ============================================================================

loadPatients();
</script>

</body>
</html>
