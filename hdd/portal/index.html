<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hospital de D√≠a - Cl√≠nica Jos√© Ingenieros</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --background: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --error: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 800px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--text);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.25rem;
    }

    .logo-text {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-name {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-success {
      background: var(--secondary);
      color: white;
    }

    /* Login Section */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .login-card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 2rem;
      width: 100%;
      max-width: 400px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .login-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-error {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .form-hint {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    /* Feed / Community */
    .feed-container {
      padding: 1rem 0;
    }

    .create-post {
      background: var(--surface);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .create-post textarea {
      width: 100%;
      border: none;
      resize: none;
      font-size: 1rem;
      min-height: 80px;
    }

    .create-post textarea:focus {
      outline: none;
    }

    .create-post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .post-options {
      display: flex;
      gap: 0.5rem;
    }

    .post-option {
      padding: 0.5rem;
      border-radius: 8px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .post-option:hover {
      background: var(--background);
      color: var(--primary);
    }

    /* Post Card */
    .post-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .post-author {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .post-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .post-content {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      white-space: pre-wrap;
    }

    .post-image {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .post-actions {
      display: flex;
      gap: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .post-action {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .post-action:hover {
      background: var(--background);
    }

    .post-action.liked {
      color: var(--error);
    }

    /* Comments */
    .comments-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .comment {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      background: var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .comment-content {
      background: var(--background);
      border-radius: 12px;
      padding: 0.5rem 0.75rem;
      flex: 1;
    }

    .comment-author {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .comment-text {
      font-size: 0.9rem;
    }

    .comment-date {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .add-comment {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .add-comment input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.9rem;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .nav-tab:hover:not(.active) {
      background: var(--background);
    }

    /* Activities */
    .activity-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .activity-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .activity-info {
      flex: 1;
    }

    .activity-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .activity-schedule {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Loading & Messages */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 1.1rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Back to main site link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Game Cards */
    .game-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .game-card:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 12px rgba(37,99,235,0.1);
    }

    .game-card.unavailable {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .game-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      flex-shrink: 0;
    }

    .game-info {
      flex: 1;
    }

    .game-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .game-desc {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .game-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .game-tag {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .game-status {
      text-align: center;
      flex-shrink: 0;
    }

    .game-status .level {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .game-status .best-score {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--secondary);
    }

    .availability-badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 10px;
      font-weight: 500;
    }

    .availability-badge.available {
      background: #dcfce7;
      color: #166534;
    }

    .availability-badge.unavailable {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    /* Game Styles */
    .game-canvas {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: block;
      touch-action: none;
    }

    .game-info {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--background);
      border-bottom: 1px solid var(--border);
    }

    .game-score {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .game-level {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .game-instructions {
      padding: 1rem;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 8px;
      margin: 1rem;
      font-size: 0.9rem;
    }

    .game-over {
      text-align: center;
      padding: 2rem;
    }

    .game-over h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .game-over p {
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    /* Memory game specific */
    .med-prescription {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem;
      text-align: center;
      font-size: 1.1rem;
      border: 2px solid var(--primary);
    }

    .med-cabinet {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.75rem;
      padding: 1rem;
    }

    .med-item {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .med-item:hover {
      border-color: var(--primary);
      transform: scale(1.02);
    }

    .med-item.selected {
      border-color: var(--secondary);
      background: #dcfce7;
    }

    .med-item .med-name {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .med-item .med-dose {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .dose-selector {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1rem;
      flex-wrap: wrap;
    }

    .dose-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .dose-btn:hover {
      border-color: var(--primary);
    }

    .dose-btn.selected {
      border-color: var(--secondary);
      background: #dcfce7;
    }

    @media (max-width: 600px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .user-menu {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <!-- Login View -->
  <div id="login-view" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-icon" style="width: 60px; height: 60px; font-size: 1.75rem; margin: 0 auto 1rem;">HdD</div>
        <h1>Hospital de D√≠a</h1>
        <p>Cl√≠nica Psiqui√°trica Jos√© Ingenieros</p>
      </div>

      <!-- Login Form -->
      <form id="login-form">
        <div class="form-group">
          <label for="dni">DNI</label>
          <input type="text" id="dni" name="dni" placeholder="Ingrese su DNI" required>
        </div>

        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" name="password" placeholder="Ingrese su contrase√±a" required>
          <p class="form-hint">Si es su primer inicio de sesi√≥n, esta ser√° su nueva contrase√±a.</p>
        </div>

        <div id="login-error" class="form-error hidden"></div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem; padding: 0.75rem;">
          Iniciar Sesi√≥n
        </button>
      </form>

      <div style="margin-top: 1.5rem; text-align: center; border-top: 1px solid var(--border); padding-top: 1.5rem;">
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">¬øPrimera vez aqu√≠?</p>
        <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showRegisterForm()">
          Registrarse
        </button>
      </div>

      <div style="margin-top: 1.5rem; text-align: center;">
        <a href="/hdd" class="back-link">‚Üê Volver a Hospital de D√≠a</a>
      </div>
    </div>
  </div>

  <!-- Register View -->
  <div id="register-view" class="login-container hidden">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-icon" style="width: 60px; height: 60px; font-size: 1.75rem; margin: 0 auto 1rem;">HdD</div>
        <h1>Registrarse</h1>
        <p>Hospital de D√≠a</p>
      </div>

      <div class="alert alert-info" style="background: #e0f2fe; color: #0369a1; margin-bottom: 1rem;">
        Solo pueden registrarse pacientes autorizados por la cl√≠nica.
      </div>

      <form id="register-form">
        <div class="form-group">
          <label for="reg-dni">DNI *</label>
          <input type="text" id="reg-dni" placeholder="Ej: 12345678" required>
          <p class="form-hint">Ingres√° tu DNI sin puntos</p>
        </div>

        <div class="form-group">
          <label for="reg-fullname">Nombre Completo *</label>
          <input type="text" id="reg-fullname" placeholder="Nombre y apellido" required>
        </div>

        <div class="form-group">
          <label for="reg-email">Email *</label>
          <input type="email" id="reg-email" placeholder="tu@email.com" required>
        </div>

        <div class="form-group">
          <label for="reg-password">Contrase√±a *</label>
          <input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres" required>
        </div>

        <div id="register-error" class="form-error hidden"></div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem; padding: 0.75rem;">
          Registrarse
        </button>
      </form>

      <div style="margin-top: 1.5rem; text-align: center;">
        <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showLoginForm()">
          ‚Üê Ya tengo cuenta
        </button>
      </div>
    </div>
  </div>

  <!-- Main App View -->
  <div id="app-view" class="hidden">
    <header class="header">
      <div class="header-content">
        <a href="/hdd/portal" class="logo">
          <div class="logo-icon">HdD</div>
          <div>
            <div class="logo-text">Hospital de D√≠a</div>
            <div class="logo-subtitle">Comunidad</div>
          </div>
        </a>

        <div class="user-menu">
          <span class="user-name" id="user-name"></span>
          <button class="btn btn-secondary" onclick="showProfileModal()">Perfil</button>
          <button class="btn btn-secondary" onclick="logout()">Salir</button>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="feed" onclick="switchTab('feed')">Comunidad</button>
        <button class="nav-tab" data-tab="games" onclick="switchTab('games')">Juegos</button>
        <button class="nav-tab" data-tab="activities" onclick="switchTab('activities')">Actividades</button>
        <button class="nav-tab" data-tab="my-posts" onclick="switchTab('my-posts')">Mis Publicaciones</button>
      </div>

      <!-- Feed Tab -->
      <div id="tab-feed" class="feed-container">
        <div class="create-post">
          <textarea id="new-post-content" placeholder="¬øQu√© quieres compartir hoy?"></textarea>
          <div class="create-post-actions">
            <div class="post-options">
              <button class="post-option" onclick="document.getElementById('image-upload').click()" title="Agregar imagen">
                üì∑
              </button>
              <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
            </div>
            <button class="btn btn-primary" onclick="createPost()">Publicar</button>
          </div>
          <div id="image-preview" class="hidden" style="margin-top: 0.5rem;">
            <img id="preview-img" style="max-height: 150px; border-radius: 8px;">
            <button class="btn btn-secondary" onclick="clearImagePreview()" style="margin-left: 0.5rem;">‚úï</button>
          </div>
        </div>

        <div id="feed-posts">
          <div class="loading">Cargando publicaciones...</div>
        </div>
      </div>

      <!-- Games Tab -->
      <div id="tab-games" class="feed-container hidden">
        <h2 style="margin-bottom: 1rem;">Juegos Terapeuticos</h2>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Ejercicios ludicos para trabajar habilidades cognitivas y motoras.</p>

        <div style="display: grid; gap: 1rem;">
          <!-- Game 1: Lawn Mower -->
          <div class="activity-card" style="cursor: pointer;" onclick="openGame('lawn-mower')">
            <div class="activity-icon" style="font-size: 2rem;">üåø</div>
            <div class="activity-info">
              <div class="activity-name">Cortadora de Cesped</div>
              <div class="activity-schedule">Motricidad fina, planificacion, atencion</div>
            </div>
            <span style="color: var(--primary);">Jugar ‚Üí</span>
          </div>

          <!-- Game 2: Memory Prescriptions -->
          <div class="activity-card" style="cursor: pointer;" onclick="openGame('memory-meds')">
            <div class="activity-icon" style="font-size: 2rem;">üíä</div>
            <div class="activity-info">
              <div class="activity-name">Memoria de Medicamentos</div>
              <div class="activity-schedule">Memoria, atencion, seguimiento de instrucciones</div>
            </div>
            <span style="color: var(--primary);">Jugar ‚Üí</span>
          </div>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="hidden" style="margin-top: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 id="game-title"></h3>
            <button class="btn btn-secondary" onclick="closeGame()">Cerrar juego</button>
          </div>
          <div id="game-area" style="background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;"></div>
        <h2 style="margin-bottom: 0.5rem;">Juegos Terapeuticos</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Actividades ludicas disenadas para estimular habilidades cognitivas y motoras. Los juegos se habilitan en horarios programados.</p>
        <div id="games-list">
          <div class="loading">Cargando juegos...</div>
        </div>
        <div id="games-progress" style="margin-top: 2rem;">
        </div>
      </div>

      <!-- Activities Tab -->
      <div id="tab-activities" class="feed-container hidden">
        <h2 style="margin-bottom: 1rem;">Actividades Semanales</h2>
        <div id="activities-list">
          <div class="activity-card">
            <div class="activity-icon">üéµ</div>
            <div class="activity-info">
              <div class="activity-name">M√∫sica</div>
              <div class="activity-schedule">Lunes 10:00 - 11:30</div>
            </div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üå±</div>
            <div class="activity-info">
              <div class="activity-name">Huerta</div>
              <div class="activity-schedule">Martes 10:00 - 12:00</div>
            </div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">ü™µ</div>
            <div class="activity-info">
              <div class="activity-name">Carpinter√≠a</div>
              <div class="activity-schedule">Mi√©rcoles 10:00 - 12:00</div>
            </div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üç≥</div>
            <div class="activity-info">
              <div class="activity-name">Cocina</div>
              <div class="activity-schedule">Jueves 10:00 - 12:00</div>
            </div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üíÉ</div>
            <div class="activity-info">
              <div class="activity-name">Expresi√≥n Corporal</div>
              <div class="activity-schedule">Viernes 10:00 - 11:30</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 2rem;">
          <h3 style="margin-bottom: 1rem;">Galer√≠a de Productos</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
            <img src="/hdd/img/kits-verduras.jpg" alt="Kits de Verduras" style="width: 100%; border-radius: 8px;">
            <img src="/hdd/img/flores-papel.jpg" alt="Flores de Papel" style="width: 100%; border-radius: 8px;">
            <img src="/hdd/img/masa-tortas.jpg" alt="Masa para Tortas" style="width: 100%; border-radius: 8px;">
            <img src="/hdd/img/ensalada-frutas.jpg" alt="Ensalada de Frutas" style="width: 100%; border-radius: 8px;">
          </div>
        </div>
      </div>

      <!-- My Posts Tab -->
      <div id="tab-my-posts" class="feed-container hidden">
        <h2 style="margin-bottom: 1rem;">Mis Publicaciones</h2>
        <div id="my-posts-list">
          <div class="loading">Cargando...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="modal-overlay hidden" onclick="closeModal(event, 'profile-modal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Mi Perfil</h3>
        <button class="modal-close" onclick="hideProfileModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="form-group">
            <label>DNI</label>
            <input type="text" id="profile-dni" disabled>
          </div>
          <div class="form-group">
            <label for="profile-email">Email</label>
            <input type="email" id="profile-email" placeholder="tu@email.com">
          </div>
          <div class="form-group">
            <label for="profile-phone">Tel√©fono</label>
            <input type="tel" id="profile-phone" placeholder="+54 11 1234-5678">
          </div>
        </form>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">

        <h4 style="margin-bottom: 1rem;">Cambiar Contrase√±a</h4>
        <form id="password-form">
          <div class="form-group">
            <label for="current-password">Contrase√±a Actual</label>
            <input type="password" id="current-password">
          </div>
          <div class="form-group">
            <label for="new-password">Nueva Contrase√±a</label>
            <input type="password" id="new-password">
          </div>
          <button type="submit" class="btn btn-secondary" style="width: 100%;">Cambiar Contrase√±a</button>
        </form>

        <div id="profile-message" class="hidden" style="margin-top: 1rem;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideProfileModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveProfile()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Comments Modal -->
  <div id="comments-modal" class="modal-overlay hidden" onclick="closeModal(event, 'comments-modal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Comentarios</h3>
        <button class="modal-close" onclick="hideCommentsModal()">&times;</button>
      </div>
      <div class="modal-body" id="comments-modal-content">
        <div class="loading">Cargando comentarios...</div>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentUser = null;
    let sessionToken = null;
    let uploadedImageUrl = null;

    // API helpers
    const API_BASE = '/api/hdd';

    async function api(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      return response.json();
    }

    // Auth
    async function login(dni, password) {
      const result = await api('/auth', {
        method: 'POST',
        body: JSON.stringify({ action: 'login', dni, password })
      });

      if (result.success) {
        sessionToken = result.sessionToken;
        currentUser = result.patient;
        localStorage.setItem('hdd_session', sessionToken);
        localStorage.setItem('hdd_user', JSON.stringify(currentUser));
        showApp();
        loadFeed();
      }

      return result;
    }

    async function logout() {
      if (sessionToken) {
        await api('/auth', {
          method: 'POST',
          body: JSON.stringify({ action: 'logout', sessionToken })
        });
      }

      sessionToken = null;
      currentUser = null;
      localStorage.removeItem('hdd_session');
      localStorage.removeItem('hdd_user');
      showLoginForm();
    }

    async function verifySession() {
      const stored = localStorage.getItem('hdd_session');
      const storedUser = localStorage.getItem('hdd_user');

      if (stored && storedUser) {
        const result = await api(`/auth?action=verify&sessionToken=${stored}`);

        if (result.valid) {
          sessionToken = stored;
          currentUser = result.patient;
          return true;
        }
      }

      localStorage.removeItem('hdd_session');
      localStorage.removeItem('hdd_user');
      return false;
    }

    // UI Navigation
    function showLoginForm() {
      document.getElementById('login-view').classList.remove('hidden');
      document.getElementById('register-view').classList.add('hidden');
      document.getElementById('app-view').classList.add('hidden');
    }

    function showRegisterForm() {
      document.getElementById('login-view').classList.add('hidden');
      document.getElementById('register-view').classList.remove('hidden');
      document.getElementById('app-view').classList.add('hidden');
    }

    function showApp() {
      document.getElementById('login-view').classList.add('hidden');
      document.getElementById('register-view').classList.add('hidden');
      document.getElementById('app-view').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.fullName;
    }

    // Registration - simplified (no code verification)
    async function register(dni, fullName, email, password) {
      const result = await api('/auth', {
        method: 'POST',
        body: JSON.stringify({
          action: 'register',
          dni,
          fullName,
          email,
          password
        })
      });

      if (result.success) {
        sessionToken = result.sessionToken;
        currentUser = result.patient;
        localStorage.setItem('hdd_session', sessionToken);
        localStorage.setItem('hdd_user', JSON.stringify(currentUser));
        showApp();
        loadFeed();
      }

      return result;
    }

    function switchTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

      document.querySelectorAll('.feed-container').forEach(c => c.classList.add('hidden'));
      document.getElementById(`tab-${tabId}`).classList.remove('hidden');

      if (tabId === 'my-posts') {
        loadMyPosts();
      }
      if (tabId === 'games') {
        loadGames();
      }
    }

    // Feed
    async function loadFeed() {
      const container = document.getElementById('feed-posts');
      container.innerHTML = '<div class="loading">Cargando publicaciones...</div>';

      const result = await api(`/community?action=feed&sessionToken=${sessionToken}`);

      if (result.posts && result.posts.length > 0) {
        container.innerHTML = result.posts.map(renderPost).join('');
      } else {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No hay publicaciones todav√≠a. ¬°S√© el primero en compartir!</p>
          </div>
        `;
      }
    }

    async function loadMyPosts() {
      const container = document.getElementById('my-posts-list');
      container.innerHTML = '<div class="loading">Cargando...</div>';

      const result = await api(`/community?action=my_posts&sessionToken=${sessionToken}`);

      if (result.posts && result.posts.length > 0) {
        container.innerHTML = result.posts.map(renderPost).join('');
      } else {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No tienes publicaciones todav√≠a.</p>
          </div>
        `;
      }
    }

    function renderPost(post) {
      const initials = post.authorName ? post.authorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
      const date = new Date(post.createdAt).toLocaleDateString('es-AR', {
        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
      });

      return `
        <div class="post-card" data-post-id="${post.id}">
          <div class="post-header">
            <div class="post-avatar">${initials}</div>
            <div>
              <div class="post-author">${post.authorName || 'An√≥nimo'}</div>
              <div class="post-date">${date}</div>
            </div>
            ${post.isOwnPost ? `
              <button class="btn btn-secondary" style="margin-left: auto; padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                      onclick="deletePost(${post.id})">Eliminar</button>
            ` : ''}
          </div>
          <div class="post-content">${escapeHtml(post.content)}</div>
          ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Imagen">` : ''}
          <div class="post-actions">
            <button class="post-action ${post.userLiked ? 'liked' : ''}" onclick="toggleLike(${post.id}, this)">
              ${post.userLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likesCount}
            </button>
            <button class="post-action" onclick="showComments(${post.id})">
              üí¨ ${post.commentsCount}
            </button>
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Actions
    async function createPost() {
      const content = document.getElementById('new-post-content').value.trim();

      if (!content) {
        alert('Escribe algo para publicar');
        return;
      }

      // Upload image if present
      let imageUrl = null;
      if (pendingImageFile) {
        imageUrl = await uploadImage();
      }

      const result = await api('/community', {
        method: 'POST',
        body: JSON.stringify({
          action: 'create_post',
          sessionToken,
          content,
          postType: imageUrl ? 'photo' : 'text',
          imageUrl: imageUrl
        })
      });

      if (result.success) {
        document.getElementById('new-post-content').value = '';
        clearImagePreview();
        loadFeed();
      } else {
        alert(result.error || 'Error al publicar');
      }
    }

    async function deletePost(postId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta publicaci√≥n?')) return;

      const result = await api('/community', {
        method: 'POST',
        body: JSON.stringify({ action: 'delete_post', sessionToken, postId })
      });

      if (result.success) {
        loadFeed();
        loadMyPosts();
      } else {
        alert(result.error || 'Error al eliminar');
      }
    }

    async function toggleLike(postId, button) {
      const result = await api('/community', {
        method: 'POST',
        body: JSON.stringify({ action: 'toggle_like', sessionToken, postId })
      });

      if (result.success) {
        const card = button.closest('.post-card');
        const countMatch = button.textContent.match(/\d+/);
        const currentCount = countMatch ? parseInt(countMatch[0]) : 0;

        if (result.liked) {
          button.classList.add('liked');
          button.innerHTML = `‚ù§Ô∏è ${currentCount + 1}`;
        } else {
          button.classList.remove('liked');
          button.innerHTML = `ü§ç ${Math.max(0, currentCount - 1)}`;
        }
      }
    }

    async function showComments(postId) {
      const modal = document.getElementById('comments-modal');
      const content = document.getElementById('comments-modal-content');
      modal.classList.remove('hidden');
      content.innerHTML = '<div class="loading">Cargando comentarios...</div>';

      const result = await api(`/community?action=post&postId=${postId}&sessionToken=${sessionToken}`);

      if (result.post) {
        let html = `
          <div class="post-content" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
            ${escapeHtml(result.post.content)}
          </div>
        `;

        if (result.comments && result.comments.length > 0) {
          html += result.comments.map(c => {
            const initials = c.authorName ? c.authorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
            const date = new Date(c.createdAt).toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
            return `
              <div class="comment">
                <div class="comment-avatar">${initials}</div>
                <div class="comment-content">
                  <div class="comment-author">${c.authorName}</div>
                  <div class="comment-text">${escapeHtml(c.content)}</div>
                  <div class="comment-date">${date}</div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          html += '<p class="text-muted">No hay comentarios todav√≠a.</p>';
        }

        html += `
          <div class="add-comment">
            <input type="text" id="comment-input-${postId}" placeholder="Escribe un comentario...">
            <button class="btn btn-primary" onclick="addComment(${postId})">Enviar</button>
          </div>
        `;

        content.innerHTML = html;
      }
    }

    async function addComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const content = input.value.trim();

      if (!content) return;

      const result = await api('/community', {
        method: 'POST',
        body: JSON.stringify({ action: 'add_comment', sessionToken, postId, content })
      });

      if (result.success) {
        showComments(postId);
        loadFeed();
      } else {
        alert(result.error || 'Error al comentar');
      }
    }

    function hideCommentsModal() {
      document.getElementById('comments-modal').classList.add('hidden');
    }

    // Image handling - upload to server
    let pendingImageFile = null;

    function handleImageUpload(input) {
      const file = input.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('La imagen es muy grande (m√°ximo 5MB)');
        return;
      }

      // Store file for upload and show preview
      pendingImageFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('image-preview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    async function uploadImage() {
      if (!pendingImageFile) return null;

      // Read as base64
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const response = await fetch('/api/upload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                image: e.target.result,
                folder: 'hdd/community'
              })
            });
            const result = await response.json();
            if (result.success) {
              resolve(result.url);
            } else {
              alert(result.error || 'Error al subir la imagen');
              resolve(null);
            }
          } catch (error) {
            console.error('Upload error:', error);
            alert('Error al subir la imagen');
            resolve(null);
          }
        };
        reader.readAsDataURL(pendingImageFile);
      });
    }

    function clearImagePreview() {
      uploadedImageUrl = null;
      pendingImageFile = null;
      document.getElementById('image-preview').classList.add('hidden');
      document.getElementById('image-upload').value = '';
    }

    // Profile
    function showProfileModal() {
      document.getElementById('profile-modal').classList.remove('hidden');
      document.getElementById('profile-dni').value = currentUser.dni;
      document.getElementById('profile-email').value = currentUser.email || '';
      document.getElementById('profile-phone').value = currentUser.phone || '';
    }

    function hideProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
      document.getElementById('profile-message').classList.add('hidden');
    }

    async function saveProfile() {
      const email = document.getElementById('profile-email').value;
      const phone = document.getElementById('profile-phone').value;

      const result = await api('/auth', {
        method: 'POST',
        body: JSON.stringify({ action: 'update_profile', sessionToken, email, phone })
      });

      const msg = document.getElementById('profile-message');
      if (result.success) {
        currentUser.email = result.patient.email;
        currentUser.phone = result.patient.phone;
        localStorage.setItem('hdd_user', JSON.stringify(currentUser));
        msg.className = 'alert alert-success';
        msg.textContent = 'Perfil actualizado';
        msg.classList.remove('hidden');
      } else {
        msg.className = 'alert alert-error';
        msg.textContent = result.error || 'Error al guardar';
        msg.classList.remove('hidden');
      }
    }

    // Modal close helper
    function closeModal(event, modalId) {
      if (event.target.classList.contains('modal-overlay')) {
        document.getElementById(modalId).classList.add('hidden');
      }
    }

    // Password form
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;

      if (!currentPassword || !newPassword) {
        alert('Complete ambos campos');
        return;
      }

      const result = await api('/auth', {
        method: 'POST',
        body: JSON.stringify({ action: 'change_password', sessionToken, currentPassword, newPassword })
      });

      const msg = document.getElementById('profile-message');
      if (result.success) {
        msg.className = 'alert alert-success';
        msg.textContent = 'Contrase√±a actualizada';
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
      } else {
        msg.className = 'alert alert-error';
        msg.textContent = result.error || 'Error al cambiar contrase√±a';
      }
      msg.classList.remove('hidden');
    });

    // Login form
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const dni = document.getElementById('dni').value;
      const password = document.getElementById('password').value;

      const errorEl = document.getElementById('login-error');
      errorEl.classList.add('hidden');

      const result = await login(dni, password);

      if (!result.success) {
        errorEl.textContent = result.error || 'Error al iniciar sesi√≥n';
        errorEl.classList.remove('hidden');
      } else if (result.firstLogin) {
        alert('¬°Bienvenido/a! Su contrase√±a ha sido configurada exitosamente.');
      }
    });

    // Register form - simplified (no code verification)
    document.getElementById('register-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const dni = document.getElementById('reg-dni').value;
      const fullName = document.getElementById('reg-fullname').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      const errorEl = document.getElementById('register-error');
      errorEl.classList.add('hidden');

      if (password.length < 6) {
        errorEl.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
        errorEl.classList.remove('hidden');
        return;
      }

      const result = await register(dni, fullName, email, password);

      if (!result.success) {
        errorEl.textContent = result.details ? `${result.error}: ${result.details}` : (result.error || 'Error al registrarse');
        errorEl.classList.remove('hidden');
      }
    });

    // =============================================
    // THERAPEUTIC GAMES
    // =============================================

    let currentGame = null;
    let gameState = {};

    function openGame(gameId) {
      document.getElementById('game-container').classList.remove('hidden');
      currentGame = gameId;

      if (gameId === 'lawn-mower') {
        document.getElementById('game-title').textContent = 'Cortadora de Cesped';
        initLawnMowerGame();
      } else if (gameId === 'memory-meds') {
        document.getElementById('game-title').textContent = 'Memoria de Medicamentos';
        initMemoryMedsGame();
      }

      // Track activity
      trackGameActivity(gameId, 'start');
    }

    function closeGame() {
      document.getElementById('game-container').classList.add('hidden');
      document.getElementById('game-area').innerHTML = '';
      if (currentGame) {
        trackGameActivity(currentGame, 'close');
      }
      currentGame = null;
      gameState = {};
    }

    function trackGameActivity(gameId, action) {
      if (sessionToken) {
        api('/auth', {
          method: 'POST',
          body: JSON.stringify({
            action: 'track_activity',
            sessionToken,
            activityType: `game_${gameId}`,
            activityData: { action, timestamp: Date.now() }
          })
        }).catch(e => console.log('Activity tracking failed:', e));
      }
    }

    // =============================================
    // GAME 1: LAWN MOWER
    // Motricidad fina, planificacion, atencion
    // =============================================

    function initLawnMowerGame() {
      const area = document.getElementById('game-area');
      gameState = {
        level: 1,
        score: 0,
        mowed: 0,
        totalGrass: 0,
        gameOver: false
      };

      area.innerHTML = `
        <div class="game-info">
          <div>
            <span class="game-score">Puntos: <span id="lawn-score">0</span></span>
          </div>
          <div class="game-level">Nivel <span id="lawn-level">1</span></div>
        </div>
        <div class="game-instructions">
          Arrastra la cortadora sobre el cesped verde para cortarlo.
          Evita las flores y la pileta. Corta todo el cesped para avanzar de nivel.
        </div>
        <canvas id="lawn-canvas" class="game-canvas" width="400" height="400"></canvas>
        <div style="text-align: center; padding: 1rem;">
          <button class="btn btn-primary" onclick="startLawnLevel()">Comenzar</button>
        </div>
      `;
    }

    function startLawnLevel() {
      const canvas = document.getElementById('lawn-canvas');
      const ctx = canvas.getContext('2d');
      const level = gameState.level;

      // Grid setup
      const gridSize = 20;
      const cols = canvas.width / gridSize;
      const rows = canvas.height / gridSize;

      // Create grid: 0=empty, 1=grass, 2=flower, 3=pool, 4=mowed
      const grid = [];
      let totalGrass = 0;

      for (let y = 0; y < rows; y++) {
        grid[y] = [];
        for (let x = 0; x < cols; x++) {
          // Border is empty
          if (x === 0 || x === cols - 1 || y === 0 || y === rows - 1) {
            grid[y][x] = 0;
          } else {
            // 70% grass
            if (Math.random() < 0.7) {
              grid[y][x] = 1;
              totalGrass++;
            } else {
              grid[y][x] = 0;
            }
          }
        }
      }

      // Add obstacles based on level
      const numFlowers = 3 + level * 2;
      const poolSize = Math.min(3 + level, 6);

      // Add flowers
      for (let i = 0; i < numFlowers; i++) {
        const x = Math.floor(Math.random() * (cols - 4)) + 2;
        const y = Math.floor(Math.random() * (rows - 4)) + 2;
        grid[y][x] = 2;
        if (grid[y][x] === 1) totalGrass--;
      }

      // Add pool (rectangle)
      const poolX = Math.floor(Math.random() * (cols - poolSize - 4)) + 2;
      const poolY = Math.floor(Math.random() * (rows - poolSize - 4)) + 2;
      for (let py = poolY; py < poolY + poolSize; py++) {
        for (let px = poolX; px < poolX + poolSize; px++) {
          if (grid[py] && grid[py][px] === 1) totalGrass--;
          if (grid[py]) grid[py][px] = 3;
        }
      }

      gameState.grid = grid;
      gameState.totalGrass = totalGrass;
      gameState.mowed = 0;
      gameState.gameOver = false;
      gameState.mowerX = 1;
      gameState.mowerY = 1;

      // Draw initial state
      drawLawnGame(ctx, grid, gridSize, gameState.mowerX, gameState.mowerY);

      // Setup touch/mouse controls
      let isDragging = false;

      const handleMove = (clientX, clientY) => {
        if (!isDragging || gameState.gameOver) return;

        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((clientX - rect.left) / gridSize);
        const y = Math.floor((clientY - rect.top) / gridSize);

        if (x >= 0 && x < cols && y >= 0 && y < rows) {
          const cell = grid[y][x];

          if (cell === 2) {
            // Hit flower - game over
            gameState.gameOver = true;
            showLawnResult(false, 'Chocaste con una flor!');
            return;
          }

          if (cell === 3) {
            // Hit pool - game over
            gameState.gameOver = true;
            showLawnResult(false, 'Caiste en la pileta!');
            return;
          }

          if (cell === 1) {
            // Mow grass
            grid[y][x] = 4;
            gameState.mowed++;
            gameState.score += 10;
            document.getElementById('lawn-score').textContent = gameState.score;

            // Check if level complete
            if (gameState.mowed >= gameState.totalGrass) {
              gameState.gameOver = true;
              showLawnResult(true, 'Nivel completado!');
              return;
            }
          }

          gameState.mowerX = x;
          gameState.mowerY = y;
          drawLawnGame(ctx, grid, gridSize, x, y);
        }
      };

      canvas.onmousedown = () => { isDragging = true; };
      canvas.onmouseup = () => { isDragging = false; };
      canvas.onmouseleave = () => { isDragging = false; };
      canvas.onmousemove = (e) => handleMove(e.clientX, e.clientY);

      canvas.ontouchstart = (e) => { isDragging = true; e.preventDefault(); };
      canvas.ontouchend = () => { isDragging = false; };
      canvas.ontouchmove = (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        handleMove(touch.clientX, touch.clientY);
      };
    }

    function drawLawnGame(ctx, grid, size, mowerX, mowerY) {
      const colors = {
        0: '#f5f5dc', // empty - beige
        1: '#22c55e', // grass - green
        2: '#ec4899', // flower - pink
        3: '#3b82f6', // pool - blue
        4: '#a3e635'  // mowed - light green
      };

      for (let y = 0; y < grid.length; y++) {
        for (let x = 0; x < grid[y].length; x++) {
          ctx.fillStyle = colors[grid[y][x]];
          ctx.fillRect(x * size, y * size, size - 1, size - 1);

          // Draw flower icon
          if (grid[y][x] === 2) {
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath();
            ctx.arc(x * size + size/2, y * size + size/2, size/4, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      // Draw mower
      ctx.fillStyle = '#ef4444';
      ctx.fillRect(mowerX * size + 2, mowerY * size + 2, size - 4, size - 4);
    }

    function showLawnResult(success, message) {
      const area = document.getElementById('game-area');
      const bonus = success ? gameState.level * 50 : 0;
      gameState.score += bonus;

      if (success) {
        trackGameActivity('lawn-mower', `level_${gameState.level}_complete`);
      } else {
        trackGameActivity('lawn-mower', `level_${gameState.level}_fail`);
      }

      area.innerHTML = `
        <div class="game-over">
          <h3>${success ? 'Excelente!' : 'Ups!'}</h3>
          <p>${message}</p>
          <p><strong>Puntuacion total: ${gameState.score}</strong></p>
          ${success ? `<p>Bonus de nivel: +${bonus} puntos</p>` : ''}
          <button class="btn btn-primary" onclick="${success ? 'nextLawnLevel()' : 'startLawnLevel()'}">
            ${success ? 'Siguiente nivel' : 'Reintentar'}
          </button>
        </div>
      `;
    }

    function nextLawnLevel() {
      gameState.level++;
      document.getElementById('lawn-level').textContent = gameState.level;
      startLawnLevel();
    }

    // =============================================
    // GAME 2: MEMORY MEDICATIONS
    // Memoria, atencion, seguimiento de instrucciones
    // =============================================

    const MEDICATIONS = [
      { name: 'Risperidona', doses: ['0.5mg', '1mg', '2mg', '3mg'] },
      { name: 'Quetiapina', doses: ['25mg', '50mg', '100mg', '200mg'] },
      { name: 'Clonazepam', doses: ['0.25mg', '0.5mg', '1mg', '2mg'] },
      { name: 'Sertralina', doses: ['25mg', '50mg', '100mg'] },
      { name: 'Fluoxetina', doses: ['10mg', '20mg', '40mg'] },
      { name: 'Levomepromazina', doses: ['2mg', '5mg', '25mg'] },
      { name: 'Lorazepam', doses: ['0.5mg', '1mg', '2.5mg'] },
      { name: 'Carbamazepina', doses: ['200mg', '400mg'] }
    ];

    const SCHEDULES = ['Manana', 'Tarde', 'Noche'];

    function initMemoryMedsGame() {
      const area = document.getElementById('game-area');
      gameState = {
        level: 1,
        score: 0,
        round: 1,
        prescription: null,
        selectedMed: null,
        selectedDose: null,
        selectedSchedule: [],
        showTime: 5000 // 5 seconds to memorize
      };

      area.innerHTML = `
        <div class="game-info">
          <div>
            <span class="game-score">Puntos: <span id="med-score">0</span></span>
          </div>
          <div class="game-level">Nivel <span id="med-level">1</span></div>
        </div>
        <div class="game-instructions">
          Memorizaras una prescripcion medica y luego debes seleccionar el medicamento correcto,
          la dosis y los horarios de toma.
        </div>
        <div id="med-game-area" style="padding: 1rem;"></div>
        <div style="text-align: center; padding: 1rem;">
          <button class="btn btn-primary" onclick="startMedRound()">Comenzar</button>
        </div>
      `;
    }

    function startMedRound() {
      const gameArea = document.getElementById('med-game-area');
      const level = gameState.level;

      // Generate random prescription
      const med = MEDICATIONS[Math.floor(Math.random() * MEDICATIONS.length)];
      const dose = med.doses[Math.floor(Math.random() * med.doses.length)];

      // Generate schedule (1-3 times based on level)
      const numTimes = Math.min(level, 3);
      const schedule = [];
      const availableSchedules = [...SCHEDULES];
      for (let i = 0; i < numTimes; i++) {
        const idx = Math.floor(Math.random() * availableSchedules.length);
        schedule.push(availableSchedules.splice(idx, 1)[0]);
      }

      gameState.prescription = { med: med.name, dose, schedule };
      gameState.selectedMed = null;
      gameState.selectedDose = null;
      gameState.selectedSchedule = [];

      // Show prescription
      gameArea.innerHTML = `
        <div class="med-prescription" style="animation: pulse 1s infinite;">
          <p style="margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Prescripcion:</p>
          <p style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem;">${med.name} ${dose}</p>
          <p style="font-size: 1rem;">${schedule.join(' - ')}</p>
        </div>
        <p style="text-align: center; color: var(--text-muted);">Memoriza esta prescripcion...</p>
        <p style="text-align: center; font-size: 2rem;" id="med-countdown">${gameState.showTime / 1000}</p>
      `;

      // Countdown
      let countdown = gameState.showTime / 1000;
      const timer = setInterval(() => {
        countdown--;
        const el = document.getElementById('med-countdown');
        if (el) el.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(timer);
          showMedSelection();
        }
      }, 1000);
    }

    function showMedSelection() {
      const gameArea = document.getElementById('med-game-area');
      const level = gameState.level;

      // Generate distractors (more with higher levels)
      const numOptions = Math.min(4 + level, MEDICATIONS.length);
      const options = [MEDICATIONS.find(m => m.name === gameState.prescription.med)];

      while (options.length < numOptions) {
        const med = MEDICATIONS[Math.floor(Math.random() * MEDICATIONS.length)];
        if (!options.find(o => o.name === med.name)) {
          options.push(med);
        }
      }

      // Shuffle options
      options.sort(() => Math.random() - 0.5);

      gameArea.innerHTML = `
        <p style="text-align: center; font-weight: 600; margin-bottom: 1rem;">Selecciona el medicamento correcto:</p>
        <div class="med-cabinet">
          ${options.map(med => `
            <div class="med-item" onclick="selectMed('${med.name}')" id="med-${med.name.replace(/\s/g, '')}">
              <div class="med-name">${med.name}</div>
            </div>
          `).join('')}
        </div>
        <div id="dose-section" class="hidden">
          <p style="text-align: center; font-weight: 600; margin: 1rem 0;">Selecciona la dosis:</p>
          <div class="dose-selector" id="dose-buttons"></div>
        </div>
        <div id="schedule-section" class="hidden">
          <p style="text-align: center; font-weight: 600; margin: 1rem 0;">Selecciona los horarios de toma:</p>
          <div class="dose-selector" id="schedule-buttons">
            ${SCHEDULES.map(s => `
              <button class="dose-btn" onclick="toggleSchedule('${s}')" id="sched-${s}">${s}</button>
            `).join('')}
          </div>
        </div>
        <div style="text-align: center; padding: 1rem;">
          <button class="btn btn-success hidden" id="med-submit" onclick="checkMedAnswer()">Confirmar</button>
        </div>
      `;
    }

    function selectMed(medName) {
      // Clear previous selection
      document.querySelectorAll('.med-item').forEach(el => el.classList.remove('selected'));

      // Select new
      const el = document.getElementById('med-' + medName.replace(/\s/g, ''));
      el.classList.add('selected');
      gameState.selectedMed = medName;

      // Show dose selection
      const med = MEDICATIONS.find(m => m.name === medName);
      const doseSection = document.getElementById('dose-section');
      const doseButtons = document.getElementById('dose-buttons');

      doseButtons.innerHTML = med.doses.map(d => `
        <button class="dose-btn" onclick="selectDose('${d}')" id="dose-${d.replace('.', '-')}">${d}</button>
      `).join('');

      doseSection.classList.remove('hidden');
      gameState.selectedDose = null;
      gameState.selectedSchedule = [];
      document.getElementById('schedule-section').classList.add('hidden');
      document.getElementById('med-submit').classList.add('hidden');
    }

    function selectDose(dose) {
      document.querySelectorAll('#dose-buttons .dose-btn').forEach(el => el.classList.remove('selected'));
      document.getElementById('dose-' + dose.replace('.', '-')).classList.add('selected');
      gameState.selectedDose = dose;

      // Show schedule selection
      document.getElementById('schedule-section').classList.remove('hidden');
      gameState.selectedSchedule = [];
      document.querySelectorAll('#schedule-buttons .dose-btn').forEach(el => el.classList.remove('selected'));
    }

    function toggleSchedule(schedule) {
      const el = document.getElementById('sched-' + schedule);
      const idx = gameState.selectedSchedule.indexOf(schedule);

      if (idx >= 0) {
        gameState.selectedSchedule.splice(idx, 1);
        el.classList.remove('selected');
      } else {
        gameState.selectedSchedule.push(schedule);
        el.classList.add('selected');
      }

      // Show submit button if at least one schedule selected
      if (gameState.selectedSchedule.length > 0) {
        document.getElementById('med-submit').classList.remove('hidden');
      } else {
        document.getElementById('med-submit').classList.add('hidden');
      }
    }

    function checkMedAnswer() {
      const p = gameState.prescription;
      const correct =
        gameState.selectedMed === p.med &&
        gameState.selectedDose === p.dose &&
        gameState.selectedSchedule.length === p.schedule.length &&
        p.schedule.every(s => gameState.selectedSchedule.includes(s));

      const gameArea = document.getElementById('med-game-area');
      const bonus = correct ? gameState.level * 30 : 0;

      if (correct) {
        gameState.score += 100 + bonus;
        trackGameActivity('memory-meds', `level_${gameState.level}_correct`);
      } else {
        trackGameActivity('memory-meds', `level_${gameState.level}_incorrect`);
      }

      document.getElementById('med-score').textContent = gameState.score;

      gameArea.innerHTML = `
        <div class="game-over">
          <h3>${correct ? 'Correcto!' : 'Incorrecto'}</h3>
          ${!correct ? `
            <p>La prescripcion era:</p>
            <div class="med-prescription" style="margin: 1rem auto; max-width: 300px;">
              <p style="font-weight: 600;">${p.med} ${p.dose}</p>
              <p>${p.schedule.join(' - ')}</p>
            </div>
          ` : ''}
          <p><strong>Puntuacion: ${gameState.score}</strong></p>
          ${correct ? `<p>Bonus: +${bonus} puntos</p>` : ''}
          <button class="btn btn-primary" onclick="${correct ? 'nextMedLevel()' : 'startMedRound()'}">
            ${correct ? 'Siguiente nivel' : 'Reintentar'}
          </button>
        </div>
      `;
    }

    function nextMedLevel() {
      gameState.level++;
      gameState.showTime = Math.max(2000, gameState.showTime - 500); // Reduce time
      document.getElementById('med-level').textContent = gameState.level;
      startMedRound();
    }

    // Games
    const THERAPEUTIC_LABELS = {
      motricidad_fina: 'Motricidad Fina',
      planificacion: 'Planificacion',
      atencion: 'Atencion',
      control_impulsos: 'Control de Impulsos',
      agilidad_mental: 'Agilidad Mental',
      memoria: 'Memoria',
      comprension_lectora: 'Comprension Lectora',
      responsabilidad_terapeutica: 'Resp. Terapeutica'
    };

    async function loadGames() {
      const container = document.getElementById('games-list');
      container.innerHTML = '<div class="loading">Cargando juegos...</div>';

      try {
        const result = await api(`/games?action=list&sessionToken=${sessionToken}`);

        if (result.games && result.games.length > 0) {
          container.innerHTML = result.games.map(g => {
            const tags = (g.therapeutic_areas || []).map(t =>
              `<span class="game-tag">${THERAPEUTIC_LABELS[t] || t}</span>`
            ).join('');

            const prog = g.progress;
            const statusHtml = prog
              ? `<div class="level">Nivel ${prog.current_level}</div>
                 <div class="best-score">Mejor: ${prog.best_score}</div>
                 <div style="font-size:0.75rem;color:var(--text-muted)">${prog.total_sessions} sesiones</div>`
              : `<div class="level">Sin jugar</div>`;

            const availBadge = g.available
              ? '<span class="availability-badge available">Disponible</span>'
              : '<span class="availability-badge unavailable">Fuera de horario</span>';

            return `
              <div class="game-card ${g.available ? '' : 'unavailable'}" onclick="${g.available ? `openGame('${g.slug}')` : ''}">
                <div class="game-icon">${g.icon || 'üéÆ'}</div>
                <div class="game-info">
                  <div class="game-name">${escapeHtml(g.name)}</div>
                  <div class="game-desc">${escapeHtml(g.description || '')}</div>
                  <div class="game-tags">${tags}</div>
                </div>
                <div class="game-status">
                  ${availBadge}
                  ${statusHtml}
                </div>
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéÆ</div><p>No hay juegos disponibles en este momento.</p></div>';
        }
      } catch (e) {
        container.innerHTML = '<div class="empty-state"><p>Error al cargar juegos.</p></div>';
      }
    }

    function openGame(slug) {
      const token = sessionToken;
      window.open(`/hdd/portal/games/${slug}.html?token=${encodeURIComponent(token)}`, '_blank');
    }

    // Init
    async function init() {
      const valid = await verifySession();
      if (valid) {
        showApp();
        loadFeed();
      } else {
        showLoginForm();
      }
    }

    init();
  </script>
</body>
</html>
