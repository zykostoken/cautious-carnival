<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cl√≠nico | HDD Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .dashboard { max-width: 1300px; margin: 0 auto; padding: 1.5rem; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; }
        .dash-header h1 { font-size: 1.3rem; color: #60a5fa; }
        .dash-header h1 span { color: #f87171; font-size: 0.7rem; background: rgba(248,113,113,0.15); padding: 2px 8px; border-radius: 4px; vertical-align: middle; margin-left: 8px; }
        .back-btn { color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.85rem; padding: 0.5rem 1rem; border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; }
        .back-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }

        /* Auth gate */
        .auth-gate { text-align: center; padding: 4rem 1rem; }
        .auth-gate h2 { color: #f87171; margin-bottom: 1rem; }
        .auth-gate a { color: #60a5fa; }

        /* Patient selector */
        .patient-selector { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .patient-selector select { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; min-width: 280px; }
        .patient-selector select option { background: #1e293b; }
        .patient-info-bar { font-size: 0.85rem; color: rgba(255,255,255,0.5); }

        /* Summary cards */
        .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.7rem; margin-bottom: 1.5rem; }
        .summary-card { background: rgba(255,255,255,0.06); border-radius: 10px; padding: 0.9rem; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
        .summary-card .val { font-size: 1.6rem; font-weight: 700; color: #fff; }
        .summary-card .lbl { font-size: 0.65rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0.2rem; }

        /* Game tabs */
        .game-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .game-tab { padding: 0.5rem 1rem; border-radius: 8px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); cursor: pointer; border: 1px solid transparent; font-size: 0.85rem; transition: all 0.2s; }
        .game-tab:hover { background: rgba(255,255,255,0.1); }
        .game-tab.active { background: rgba(96,165,250,0.15); color: #60a5fa; border-color: rgba(96,165,250,0.3); }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-bottom: 1.5rem; }
        .chart-box { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 1rem; border: 1px solid rgba(255,255,255,0.06); }
        .chart-box h3 { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 0.6rem; }
        .chart-box canvas { max-height: 260px; }
        .chart-box.full { grid-column: 1 / -1; }

        /* Color mood timeline */
        .mood-timeline { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 1.5rem; }
        .mood-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; position: relative; }
        .mood-dot:hover { transform: scale(1.3); border-color: rgba(255,255,255,0.4); }
        .mood-dot .tooltip { display: none; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; z-index: 10; }
        .mood-dot:hover .tooltip { display: block; }

        /* Sessions table */
        .sessions-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
        .sessions-table th { text-align: left; padding: 0.5rem; color: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.5px; }
        .sessions-table td { padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.04); color: rgba(255,255,255,0.7); }
        .sessions-table tr:hover td { background: rgba(255,255,255,0.03); }

        .loading { text-align: center; padding: 4rem; color: rgba(255,255,255,0.4); }
        .no-data { text-align: center; padding: 3rem; color: rgba(255,255,255,0.3); font-style: italic; }
        .section-title { font-size: 1rem; color: rgba(255,255,255,0.6); margin: 1.5rem 0 0.8rem; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .summary-row { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="dash-header">
        <h1>Dashboard Cl√≠nico <span>SOLO PROFESIONAL</span></h1>
        <a href="/hdd/admin/" class="back-btn">‚Üê Panel Admin</a>
    </div>
    <div id="content"><div class="loading">Verificando acceso...</div></div>
</div>

<script>
const SB_URL = 'https://yqpqfzvgcmvxvqzvtajx.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcHFmenZnY212eHZxenZ0YWp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1OTMzODksImV4cCI6MjA2NTE2OTM4OX0.jM2YEBXQ0YFwFOBu3mGbU3NxCez29x8RKYYDV2d8snk';
const sb = window.supabase.createClient(SB_URL, SB_KEY);

const GAMES = {
    'lawn-mower': { name: 'Cortadora de C√©sped', icon: 'üåø', color: '#22c55e' },
    'medication-memory': { name: 'Memoria de Medicaci√≥n', icon: 'üíä', color: '#3b82f6' },
    'pill-organizer': { name: 'Organizador de Pastillas', icon: 'üéØ', color: '#f59e0b' },
    'daily-routine': { name: 'Rutina Diaria', icon: 'üìÖ', color: '#06b6d4' },
    'fridge-logic': { name: 'L√≥gica de Heladera', icon: 'üßä', color: '#8b5cf6' },
    'super-market': { name: 'Supermercado', icon: 'üõí', color: '#ec4899' },
    'neuro-chef': { name: 'Neuro-Chef', icon: 'üë®‚Äçüç≥', color: '#a855f7' },
    'neuro-chef-v2': { name: 'Neuro-Chef v2', icon: 'üß†', color: '#a855f7' }
};

let charts = {};
let currentPatient = null;
let allData = {};

// Auth check
(async function init() {
    const adminSession = localStorage.getItem('hdd_admin_session');
    if (!adminSession) {
        document.getElementById('content').innerHTML = `
            <div class="auth-gate">
                <h2>Acceso restringido</h2>
                <p>Este dashboard es solo para profesionales autorizados.</p>
                <p style="margin-top:1rem;"><a href="/hdd/admin/">Iniciar sesi√≥n como administrador</a></p>
            </div>`;
        return;
    }

    // Verify session
    try {
        const res = await fetch('/api/hdd/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'verify_session', sessionToken: adminSession })
        });
        const d = await res.json();
        if (!d.valid) throw new Error('invalid');
    } catch(e) {
        // Allow if session exists (offline resilience)
        console.warn('Admin verify failed, proceeding with stored session');
    }

    await loadPatients();
})();

async function loadPatients() {
    const { data: patients } = await sb.from('hdd_patients').select('id, full_name, patient_dni, dni, created_at').order('full_name');
    if (!patients || patients.length === 0) {
        document.getElementById('content').innerHTML = '<div class="no-data">No hay pacientes registrados.</div>';
        return;
    }

    let html = `<div class="patient-selector">
        <select id="patientSelect"><option value="">Seleccionar paciente...</option>`;
    patients.forEach(p => {
        html += `<option value="${p.id}">${p.full_name || 'Sin nombre'} ‚Äî DNI: ${p.patient_dni || p.dni || '?'}</option>`;
    });
    html += `</select><span class="patient-info-bar" id="patientInfoBar"></span></div>
        <div id="dashContent"><div class="no-data">Seleccion√° un paciente para ver su evoluci√≥n cl√≠nica.</div></div>`;
    document.getElementById('content').innerHTML = html;

    document.getElementById('patientSelect').addEventListener('change', function() {
        if (this.value) loadPatientData(this.value);
    });

    // Auto-select from URL param
    const urlPid = new URLSearchParams(window.location.search).get('patient_id');
    if (urlPid) {
        document.getElementById('patientSelect').value = urlPid;
        loadPatientData(urlPid);
    }
}

async function loadPatientData(pid) {
    currentPatient = pid;
    document.getElementById('dashContent').innerHTML = '<div class="loading">Cargando datos cl√≠nicos...</div>';

    try {
        // 1. Obtener paciente por ID para conseguir su DNI
        const patRes = await sb.from('hdd_patients').select('*').eq('id', pid).single();
        const patient = patRes.data;
        if (!patient) throw new Error('Paciente no encontrado');

        const dni = patient.patient_dni || patient.dni;
        if (!dni) throw new Error('Paciente sin DNI registrado');

        // 2. Consultar por DNI ‚Äî as√≠ guardan todos los juegos
        const [metRes, moodRes] = await Promise.all([
            sb.from('hdd_game_metrics')
                .select('*')
                .eq('patient_dni', dni)
                .order('session_date', { ascending: true }),
            sb.from('hdd_mood_entries')
                .select('*')
                .eq('patient_dni', dni)
                .order('recorded_at', { ascending: true })
        ]);

        const metrics = metRes.data || [];
        const moods = moodRes.data || [];

        // Sessions = registros de tipo session_summary (uno por partida)
        const sessions = metrics.filter(m => m.metric_type === 'session_summary' || (!m.metric_type || m.metric_type === 'session'));

        document.getElementById('patientInfoBar').textContent =
            `DNI: ${dni} | Ingreso: ${patient.created_at ? new Date(patient.created_at).toLocaleDateString('es-AR') : '?'} | Registros: ${metrics.length}`;

        allData = { sessions, metrics, moods, patient, dni };
        renderDashboard(sessions, metrics, moods);
    } catch(e) {
        console.error(e);
        document.getElementById('dashContent').innerHTML = `<div class="no-data">Error cargando datos: ${e.message}</div>`;
    }
}

function renderDashboard(sessions, metrics, moods) {
    const dc = document.getElementById('dashContent');
    Object.values(charts).forEach(c => c.destroy());
    charts = {};

    if (metrics.length === 0 && moods.length === 0) {
        dc.innerHTML = '<div class="no-data">Sin datos registrados para este paciente a√∫n.<br><small style="color:rgba(255,255,255,0.3)">Los datos aparecen a medida que el paciente juega y selecciona colores.</small></div>';
        return;
    }

    // Agregados globales desde hdd_game_metrics
    const gameSessions = metrics.filter(m => m.metric_type === 'session_summary');
    const biometSessions = metrics.filter(m => m.metric_type === 'session_biomet');
    const colorEntries = metrics.filter(m => m.metric_type === 'color_eleccion');

    const totalSessions = gameSessions.length;
    const completedSessions = gameSessions.filter(s => s.completed).length;
    const totalTimeSec = gameSessions.reduce((a, s) => a + (s.duration_seconds || 0), 0);
    const totalDays = new Set(gameSessions.map(s => (s.session_date || s.created_at || '').split('T')[0]).filter(Boolean)).size;

    // RT promedio desde biomet
    const rtValues = biometSessions.map(m => m.metric_data?.rt_mean_ms).filter(v => v > 0);
    const avgRT = rtValues.length ? Math.round(rtValues.reduce((a, b) => a + b, 0) / rtValues.length) : '‚Äî';

    // Juegos √∫nicos
    const gamesSlugs = [...new Set(gameSessions.map(s => s.game_slug).filter(Boolean))];

    // Summary cards
    let html = `<div class="summary-row">
        <div class="summary-card"><div class="val">${totalSessions}</div><div class="lbl">Sesiones juego</div></div>
        <div class="summary-card"><div class="val">${completedSessions}</div><div class="lbl">Completadas</div></div>
        <div class="summary-card"><div class="val">${totalDays}</div><div class="lbl">D√≠as activos</div></div>
        <div class="summary-card"><div class="val">${Math.round(totalTimeSec / 60)}min</div><div class="lbl">Tiempo total</div></div>
        <div class="summary-card"><div class="val">${avgRT}</div><div class="lbl">RT promedio (ms)</div></div>
        <div class="summary-card"><div class="val">${gamesSlugs.length}</div><div class="lbl">Juegos distintos</div></div>
        <div class="summary-card"><div class="val">${moods.length + colorEntries.length}</div><div class="lbl">Registros color</div></div>
    </div>`;

    // Timeline de colores ‚Äî combina hdd_mood_entries + color_eleccion en hdd_game_metrics
    const allColors = [
        ...moods.map(m => ({ hex: m.color_hex, id: m.color_id, date: m.recorded_at || m.created_at, ctx: m.context_type || 'game' })),
        ...colorEntries.map(m => ({ hex: m.metric_data?.color_hex, id: m.metric_data?.color_id, date: m.session_date || m.created_at, ctx: m.metric_data?.context_type || m.game_slug }))
    ].filter(c => c.hex).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (allColors.length > 0) {
        html += `<div class="section-title">Colores seleccionados (l√≠nea temporal ‚Äî ${allColors.length} registros)</div><div class="mood-timeline">`;
        allColors.forEach(c => {
            const d = new Date(c.date).toLocaleDateString('es-AR', { day:'2-digit', month:'short' });
            html += `<div class="mood-dot" style="background:${c.hex}"><div class="tooltip">${d} ‚Äî ${c.ctx}</div></div>`;
        });
        html += `</div>`;
    } else {
        html += `<div class="section-title">Colores seleccionados</div><div class="no-data" style="padding:1rem;">Sin registros de color a√∫n.</div>`;
    }

    // Charts area
    html += `<div class="section-title">Evoluci√≥n Longitudinal</div>`;
    html += `<div class="charts-grid">
        <div class="chart-box"><h3>Tiempo de Reacci√≥n (ms)</h3><canvas id="chartRT"></canvas></div>
        <div class="chart-box"><h3>Puntaje por sesi√≥n</h3><canvas id="chartScore"></canvas></div>
        <div class="chart-box"><h3>Errores (omisi√≥n vs comisi√≥n)</h3><canvas id="chartErrors"></canvas></div>
        <div class="chart-box full"><h3>Tremor / Hesitaciones</h3><canvas id="chartTremor"></canvas></div>
    </div>`;

    // Tabla de sesiones
    html += `<div class="section-title">Historial de Sesiones (${totalSessions} registros)</div>
    <div style="overflow-x:auto;">
    <table class="sessions-table">
        <thead><tr>
            <th>Fecha</th><th>Juego</th><th>Nivel</th><th>Puntaje</th><th>Duraci√≥n</th><th>RT (ms)</th><th>Omisiones</th><th>Comisiones</th><th>Completado</th>
        </tr></thead><tbody>`;

    const rows = gameSessions.slice().reverse().map(s => {
        const game = GAMES[s.game_slug] || { name: s.game_slug || 'juego', icon: 'üéÆ' };
        const dt = (s.session_date || s.created_at) ? new Date(s.session_date || s.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short', year:'2-digit' }) : '?';
        // Buscar biomet correspondiente a esta sesi√≥n
        const bio = biometSessions.find(b => b.game_slug === s.game_slug && Math.abs(new Date(b.session_date||b.created_at) - new Date(s.session_date||s.created_at)) < 60000);
        const bd = bio?.metric_data || {};
        return `<tr>
            <td>${dt}</td>
            <td>${game.icon} ${game.name}</td>
            <td>${s.level_reached ?? '‚Äî'}</td>
            <td>${s.score ?? s.metric_value ?? 0}</td>
            <td>${s.duration_seconds ? Math.round(s.duration_seconds) + 's' : '‚Äî'}</td>
            <td>${bd.rt_mean_ms ? Math.round(bd.rt_mean_ms) : '‚Äî'}</td>
            <td>${bd.errores_omision ?? '‚Äî'}</td>
            <td>${bd.errores_comision ?? '‚Äî'}</td>
            <td>${s.completed ? '‚úì' : '‚úó'}</td>
        </tr>`;
    });

    html += rows.join('') || '<tr><td colspan="9" style="text-align:center;color:rgba(255,255,255,0.3);padding:2rem;">Sin sesiones registradas</td></tr>';
    html += `</tbody></table></div>`;

    dc.innerHTML = html;
    requestAnimationFrame(() => renderCharts(gameSessions, biometSessions, allColors));
}

function getGameSlug(session) {
    return session.game_slug || 'unknown';
}

function renderCharts(gameSessions, biometSessions, allColors) {
    const chartOpts = {
        responsive: true,
        plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } } } },
        scales: {
            x: { ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
            y: { ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.06)' } }
        }
    };

    // RT chart: de biomet sessions
    const rtData = biometSessions.filter(m => m.metric_data?.rt_mean_ms > 0).sort((a, b) => new Date(a.session_date||a.created_at) - new Date(b.session_date||b.created_at));
    if (rtData.length > 0) {
        const byGame = {};
        rtData.forEach(m => {
            const slug = m.game_slug || 'unknown';
            if (!byGame[slug]) byGame[slug] = [];
            byGame[slug].push({ date: m.session_date || m.created_at, rt: m.metric_data.rt_mean_ms });
        });
        const allDates = [...new Set(rtData.map(m => (m.session_date||m.created_at).split('T')[0]))].sort();
        const datasets = Object.entries(byGame).map(([slug, pts]) => {
            const game = GAMES[slug] || { name: slug, color: '#6b7280' };
            return {
                label: game.name || slug,
                data: allDates.map(d => { const p = pts.find(x => (x.date||'').startsWith(d)); return p ? p.rt : null; }),
                borderColor: game.color || '#60a5fa', tension: 0.3, spanGaps: true, pointRadius: 4
            };
        });
        charts.rt = new Chart(document.getElementById('chartRT'), {
            type: 'line',
            data: { labels: allDates, datasets },
            options: chartOpts
        });
    }

    // Score chart
    const scoreSessions = gameSessions.filter(s => (s.score ?? s.metric_value) > 0).sort((a, b) => new Date(a.session_date||a.created_at) - new Date(b.session_date||b.created_at));
    if (scoreSessions.length > 0) {
        charts.score = new Chart(document.getElementById('chartScore'), {
            type: 'bar',
            data: {
                labels: scoreSessions.map(s => new Date(s.session_date||s.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short' })),
                datasets: [{ label: 'Puntaje', data: scoreSessions.map(s => s.score ?? s.metric_value ?? 0),
                    backgroundColor: scoreSessions.map(s => GAMES[s.game_slug]?.color || '#6b7280'), borderRadius: 4 }]
            },
            options: { ...chartOpts, plugins: { ...chartOpts.plugins, legend: { display: false } } }
        });
    }

    // Errors chart: omisiones y comisiones desde biomet
    const errData = biometSessions.filter(m => m.metric_data?.errores_omision != null || m.metric_data?.errores_comision != null).sort((a, b) => new Date(a.session_date||a.created_at) - new Date(b.session_date||b.created_at));
    if (errData.length > 0) {
        charts.errors = new Chart(document.getElementById('chartErrors'), {
            type: 'bar',
            data: {
                labels: errData.map(m => new Date(m.session_date||m.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short' })),
                datasets: [
                    { label: 'Omisiones', data: errData.map(m => m.metric_data.errores_omision || 0), backgroundColor: 'rgba(239,68,68,0.7)', borderRadius: 3 },
                    { label: 'Comisiones', data: errData.map(m => m.metric_data.errores_comision || 0), backgroundColor: 'rgba(245,158,11,0.7)', borderRadius: 3 }
                ]
            },
            options: chartOpts
        });
    }

    // Tremor / Hesitaciones chart desde biomet
    const tremorData = biometSessions.filter(m => m.metric_data?.tremor_reposo_px != null).sort((a, b) => new Date(a.session_date||a.created_at) - new Date(b.session_date||b.created_at));
    if (tremorData.length > 0) {
        charts.tremor = new Chart(document.getElementById('chartTremor'), {
            type: 'line',
            data: {
                labels: tremorData.map(m => new Date(m.session_date||m.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short' })),
                datasets: [
                    { label: 'Tremor reposo (px)', data: tremorData.map(m => m.metric_data.tremor_reposo_px || 0), borderColor: '#f87171', tension: 0.3, yAxisID: 'y' },
                    { label: 'Hesitaciones', data: tremorData.map(m => m.metric_data.hesitaciones_count || 0), borderColor: '#fbbf24', tension: 0.3, yAxisID: 'y1' }
                ]
            },
            options: {
                ...chartOpts,
                scales: {
                    ...chartOpts.scales,
                    y: { ...chartOpts.scales.y, position: 'left', title: { display: true, text: 'Tremor px', color: 'rgba(255,255,255,0.3)' } },
                    y1: { ticks: { color: 'rgba(255,255,255,0.3)' }, grid: { drawOnChartArea: false }, position: 'right', title: { display: true, text: 'Hesitaciones', color: 'rgba(255,255,255,0.3)' } }
                }
            }
        });
    }
}
</script>
</body>
</html>
