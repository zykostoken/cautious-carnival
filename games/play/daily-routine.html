<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutina Diaria | CJI HDD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/games/shared/biomet.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #0a0f1e;
            color: #e2e8f0;
            font-family: system-ui, sans-serif;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding: 14px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left a { color: rgba(255,255,255,0.4); text-decoration: none; font-size: 0.8rem; display: block; }
        .header-left h1 { font-size: 1.1rem; font-weight: 700; margin-top: 2px; }
        .header-right { text-align: right; }
        #timer-display { font-size: 1.6rem; font-family: monospace; font-weight: 700; color: #7c3aed; }
        #patient-display { font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-top: 2px; }

        /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
        #progress-bar-wrap {
            background: rgba(255,255,255,0.05);
            padding: 10px 20px;
            display: flex; align-items: center; gap: 12px;
        }
        #progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        #progress-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #a78bfa); border-radius: 3px; transition: width .4s ease; width: 0%; }
        #progress-label { font-size: 0.75rem; color: rgba(255,255,255,0.5); white-space: nowrap; }

        /* ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ */
        #start-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: calc(100vh - 55px); padding: 24px;
        }
        .start-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 40px; max-width: 480px; width: 100%; text-align: center;
        }
        .start-card h2 { font-size: 1.8rem; margin-bottom: 8px; }
        .start-card p { color: rgba(255,255,255,0.6); margin-bottom: 24px; line-height: 1.6; }
        .btn-start {
            display: inline-block; padding: 16px 48px;
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            border: none; border-radius: 14px; color: #fff;
            font-size: 1.15rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 20px rgba(124,58,237,0.4);
            transition: all .2s;
        }
        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(124,58,237,0.5); }

        /* ‚îÄ‚îÄ PHASE 1: PHOTO GRID ‚îÄ‚îÄ */
        #phase1 { display: none; padding: 16px; }

        .phase-title {
            font-size: 0.7rem; font-weight: 600; letter-spacing: 0.15em;
            text-transform: uppercase; color: rgba(255,255,255,0.35);
            text-align: center; margin-bottom: 12px;
        }

        #habits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-width: 1000px; margin: 0 auto;
        }

        .habit-card {
            position: relative;
            width: 100%; padding-top: 80%;
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all .2s;
            background: #1e293b;
        }
        .habit-card:hover { transform: scale(1.04); }
        .habit-card.selected {
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167,139,250,0.3), 0 8px 30px rgba(124,58,237,0.3);
        }
        .habit-card.unhealthy.selected {
            border-color: #f87171;
            box-shadow: 0 0 0 3px rgba(248,113,113,0.3);
        }
        .habit-photo {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            display: block;
        }
        .habit-photo-fallback {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--fb-from, #1e293b), var(--fb-to, #334155));
        }
        /* Overlay siempre visible pero sutil - se intensifica al seleccionar */
        .habit-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            transition: all .2s;
        }
        .habit-card.selected .habit-overlay {
            background: linear-gradient(to top, rgba(109,40,217,0.85) 0%, rgba(109,40,217,0.15) 100%);
        }
        .habit-card.unhealthy.selected .habit-overlay {
            background: linear-gradient(to top, rgba(239,68,68,0.85) 0%, rgba(239,68,68,0.15) 100%);
        }
        .habit-check {
            position: absolute; top: 8px; right: 8px;
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; opacity: 0; transition: all .2s;
        }
        .habit-card.selected .habit-check { opacity: 1; background: #7c3aed; border-color: #a78bfa; }
        .habit-card.unhealthy.selected .habit-check { background: #dc2626; border-color: #f87171; }

        /* tiny label bottom ‚Äî visible but subtle */
        .habit-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 6px 8px 8px;
            font-size: 0.65rem; font-weight: 600;
            color: rgba(255,255,255,0.85);
            letter-spacing: 0.02em;
            z-index: 2;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
        }

        /* Button to advance */
        .btn-next-phase {
            display: block; margin: 20px auto 0;
            padding: 14px 40px; max-width: 320px; width: 100%;
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            border: none; border-radius: 14px; color: #fff;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            opacity: 0.35; transition: all .3s;
        }
        .btn-next-phase.ready { opacity: 1; box-shadow: 0 4px 20px rgba(124,58,237,0.4); }
        .btn-next-phase.ready:hover { transform: translateY(-2px); }

        /* ‚îÄ‚îÄ PHASE 2: TIMELINE ‚îÄ‚îÄ */
        #phase2 { display: none; padding: 16px; }

        #selected-pool {
            display: flex; flex-wrap: wrap; gap: 8px;
            justify-content: center; margin-bottom: 16px;
            min-height: 80px;
        }
        .pool-card {
            position: relative; width: 72px; height: 72px;
            border-radius: 12px; overflow: hidden; cursor: grab;
            border: 2px solid rgba(255,255,255,0.15);
            background: #1e293b; flex-shrink: 0;
            transition: all .2s;
        }
        .pool-card:hover { transform: scale(1.08); border-color: rgba(167,139,250,0.5); }
        .pool-card.placed { opacity: 0.25; cursor: default; pointer-events: none; }
        .pool-card img { width: 100%; height: 100%; object-fit: cover; }
        .pool-card .pool-emoji { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }

        #timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 700px; margin: 0 auto;
        }
        .timeline-group { }
        .timeline-group-title {
            font-size: 0.65rem; font-weight: 700; letter-spacing: 0.12em;
            text-transform: uppercase; padding: 6px 4px;
            color: rgba(255,255,255,0.4); text-align: center;
        }
        .timeline-slot {
            position: relative;
            width: 100%; padding-top: 80%;
            border-radius: 12px; overflow: hidden;
            border: 2px dashed rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.03);
            cursor: pointer; transition: all .25s;
        }
        .timeline-slot.drop-over { border-color: #a78bfa; background: rgba(124,58,237,0.1); transform: scale(1.03); }
        .timeline-slot.filled { border-style: solid; border-color: #7c3aed; }
        .timeline-slot img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        .timeline-slot .slot-emoji { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .timeline-slot .slot-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 4px 6px 6px;
            font-size: 0.6rem; font-weight: 600;
            color: rgba(255,255,255,0.9);
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            z-index: 2;
        }
        .timeline-slot .slot-order {
            position: absolute; top: 6px; left: 6px;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(0,0,0,0.6); color: #fff;
            font-size: 0.65rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            z-index: 3;
        }
        .slot-remove {
            position: absolute; top: 6px; right: 6px;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.7); cursor: pointer;
            font-size: 0.7rem; display: none; align-items: center; justify-content: center;
            z-index: 4;
        }
        .timeline-slot.filled:hover .slot-remove { display: flex; }

        .btn-finish-phase {
            display: block; margin: 20px auto 0;
            padding: 14px 40px; max-width: 320px; width: 100%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none; border-radius: 14px; color: #fff;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            opacity: 0.35; transition: all .3s;
        }
        .btn-finish-phase.ready { opacity: 1; box-shadow: 0 4px 20px rgba(34,197,94,0.4); }

        /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
        #results { display: none; padding: 24px; }
        .results-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px; padding: 32px; max-width: 600px; margin: 0 auto; text-align: center;
        }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a78bfa);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem; font-weight: 800;
        }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 0.85rem; }
        .result-row:last-child { border: none; }
        .btn-replay { display: inline-block; margin-top: 20px; padding: 12px 32px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); background: transparent; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 0.9rem; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeUp .25s ease forwards; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <a id="back-link" href="/hdd/portal/">‚Üê Portal</a>
        <h1>Rutina Diaria</h1>
    </div>
    <div class="header-right">
        <div id="timer-display">00:00</div>
        <div id="patient-display">‚Äî</div>
    </div>
</header>

<div id="progress-bar-wrap" style="display:none">
    <div id="progress-bar"><div id="progress-fill"></div></div>
    <div id="progress-label">0 seleccionadas</div>
</div>

<!-- START SCREEN -->
<div id="start-screen">
    <div class="start-card">
        <h2>Mi Rutina Diaria</h2>
        <p>Seleccion√° las actividades que forman parte de una rutina saludable, y luego orden√°las en el d√≠a.</p>
        <button class="btn-start" onclick="beginGame()">Comenzar</button>
    </div>
</div>

<!-- PHASE 1 -->
<div id="phase1">
    <p class="phase-title">¬øQu√© hac√©s en tu d√≠a? Seleccion√° lo que corresponde</p>
    <div id="habits-grid"></div>
    <button id="btn-to-phase2" class="btn-next-phase" disabled onclick="goToPhase2()">
        Continuar ‚Üí
    </button>
</div>

<!-- PHASE 2 -->
<div id="phase2">
    <p class="phase-title">Organiz√° tu d√≠a: coloc√° cada actividad en su momento</p>
    <div id="selected-pool"></div>
    <div id="timeline">
        <div class="timeline-group">
            <div class="timeline-group-title">Ma√±ana</div>
            <div id="slots-morning"></div>
        </div>
        <div class="timeline-group">
            <div class="timeline-group-title">Tarde</div>
            <div id="slots-afternoon"></div>
        </div>
        <div class="timeline-group">
            <div class="timeline-group-title">Noche</div>
            <div id="slots-evening"></div>
        </div>
    </div>
    <button id="btn-finish" class="btn-finish-phase" disabled onclick="finishGame()">
        Ver resultados
    </button>
</div>

<!-- RESULTS -->
<div id="results">
    <div class="results-card animate-in" id="results-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ================================================================
// SUPABASE
// ================================================================
const SUPABASE_URL = 'https://yqpqfzvgcmvxvqzvtajx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcHFmenZnY212eHZxenZ0YWp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1OTMzODksImV4cCI6MjA2NTE2OTM4OX0.jM2YEBXQ0YFwFOBu3mGbU3NxCez29x8RKYYDV2d8snk';
let supabase = null;
try { if (window.supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}

// ================================================================
// HABITS DATA ‚Äî con fotos de Unsplash (IDs confiables) + emoji fallback
// ================================================================
const HABITS = [
    // MORNING
    {
        id: 'despertarse',
        label: 'Levantarse a horario',
        emoji: '‚è∞',
        photo: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#1a2744', fbTo: '#2d3f6e',
        healthy: true, phase: 'morning', order: 1
    },
    {
        id: 'higiene_am',
        label: 'Higiene personal',
        emoji: 'ü™•',
        photo: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0f3544', fbTo: '#1a5c6e',
        healthy: true, phase: 'morning', order: 2
    },
    {
        id: 'desayuno',
        label: 'Desayuno',
        emoji: 'ü•ê',
        photo: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#3d2000', fbTo: '#7a4800',
        healthy: true, phase: 'morning', order: 3
    },
    {
        id: 'medicacion_am',
        label: 'Medicaci√≥n ma√±ana',
        emoji: 'üíä',
        photo: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0f3320', fbTo: '#1a5c3a',
        healthy: true, phase: 'morning', order: 4
    },
    {
        id: 'tender_cama',
        label: 'Tender la cama',
        emoji: 'üõèÔ∏è',
        photo: 'https://images.unsplash.com/photo-1505693314120-0d443867891c?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#2a1a0f', fbTo: '#4a3020',
        healthy: true, phase: 'morning', order: 5
    },
    {
        id: 'ejercicio',
        label: 'Actividad f√≠sica',
        emoji: 'üèÉ',
        photo: 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#1a2e0f', fbTo: '#2e5020',
        healthy: true, phase: 'morning', order: 6
    },
    // AFTERNOON
    {
        id: 'almuerzo',
        label: 'Almuerzo',
        emoji: 'üçΩÔ∏è',
        photo: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#3d1500', fbTo: '#7a3500',
        healthy: true, phase: 'afternoon', order: 1
    },
    {
        id: 'taller',
        label: 'Taller del HDD',
        emoji: 'üè•',
        photo: 'https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0a1a3d', fbTo: '#1a3070',
        healthy: true, phase: 'afternoon', order: 2
    },
    {
        id: 'hobby',
        label: 'Hobby / actividad',
        emoji: 'üé®',
        photo: 'https://images.unsplash.com/photo-1452802447250-470a88ac82bc?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#2a0a3d', fbTo: '#4a1a70',
        healthy: true, phase: 'afternoon', order: 3
    },
    {
        id: 'merienda',
        label: 'Merienda',
        emoji: '‚òï',
        photo: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#2d1500', fbTo: '#5a3000',
        healthy: true, phase: 'afternoon', order: 4
    },
    {
        id: 'social',
        label: 'Contacto social',
        emoji: 'üë•',
        photo: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0f2a3d', fbTo: '#1a4a6e',
        healthy: true, phase: 'afternoon', order: 5
    },
    // EVENING
    {
        id: 'cena',
        label: 'Cena',
        emoji: 'ü•ó',
        photo: 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#1a0a2d', fbTo: '#2d1a50',
        healthy: true, phase: 'evening', order: 1
    },
    {
        id: 'medicacion_pm',
        label: 'Medicaci√≥n noche',
        emoji: 'üíä',
        photo: 'https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0a1a2d', fbTo: '#1a2d4a',
        healthy: true, phase: 'evening', order: 2
    },
    {
        id: 'relajacion',
        label: 'Relajaci√≥n',
        emoji: 'üßò',
        photo: 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0a2030', fbTo: '#103a50',
        healthy: true, phase: 'evening', order: 3
    },
    {
        id: 'higiene_pm',
        label: 'Higiene nocturna',
        emoji: 'üöø',
        photo: 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0f2535', fbTo: '#1a3d52',
        healthy: true, phase: 'evening', order: 4
    },
    {
        id: 'dormir',
        label: 'Dormir a horario',
        emoji: 'üò¥',
        photo: 'https://images.unsplash.com/photo-1541480601022-2308c0f02487?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#05050f', fbTo: '#0f0f28',
        healthy: true, phase: 'evening', order: 5
    },
    // UNHEALTHY
    {
        id: 'saltear_comida',
        label: 'No comer',
        emoji: 'üö´',
        photo: 'https://images.unsplash.com/photo-1517093157656-b9eccef91cb1?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#2d0505', fbTo: '#4a0a0a',
        healthy: false, phase: null, order: 0
    },
    {
        id: 'pantallas',
        label: 'Pantallas toda la noche',
        emoji: 'üì±',
        photo: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#0a0a2d', fbTo: '#15154a',
        healthy: false, phase: null, order: 0
    },
    {
        id: 'aislarse',
        label: 'Aislarse todo el d√≠a',
        emoji: 'üö™',
        photo: 'https://images.unsplash.com/photo-1474631245212-32dc3c8310c6?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#1a1a1a', fbTo: '#2d2d2d',
        healthy: false, phase: null, order: 0
    },
    {
        id: 'dormir_dia',
        label: 'Dormir todo el d√≠a',
        emoji: 'üò™',
        photo: 'https://images.unsplash.com/photo-1493894473891-10fc1e5dbd22?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#1a0a2d', fbTo: '#2d1a4a',
        healthy: false, phase: null, order: 0
    },
    {
        id: 'no_medicacion',
        label: 'No tomar medicaci√≥n',
        emoji: '‚ùå',
        photo: 'https://images.unsplash.com/photo-1583947215259-38e31be8751f?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#2d0a0a', fbTo: '#4a1515',
        healthy: false, phase: null, order: 0
    },
    {
        id: 'comida_chatarra',
        label: 'Solo comida chatarra',
        emoji: 'üçî',
        photo: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=300&h=220&fit=crop&auto=format&q=80',
        fbFrom: '#3d1500', fbTo: '#6e2d00',
        healthy: false, phase: null, order: 0
    },
];

// ================================================================
// STATE
// ================================================================
const HEALTHY_REQUIRED = 8;
const state = {
    patientDni: 'DEMO',
    startTime: null,
    timerInterval: null,
    selected: new Set(),   // habit ids
    placements: {},        // slot_id ‚Üí habit_id
    draggingId: null,
    totalActions: 0,
    hesitations: 0,
    lastActionTime: null,
};

// ================================================================
// GAME START
// ================================================================
function beginGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('phase1').style.display = 'block';
    document.getElementById('progress-bar-wrap').style.display = 'flex';

    const params = new URLSearchParams(window.location.search);
    state.patientDni = params.get('patient_id')
        || (function(){try{return localStorage.getItem('hdd_patient_id')||sessionStorage.getItem('hdd_patient_id')}catch(e){return null}})()
        || 'DEMO';
    document.getElementById('patient-display').textContent = state.patientDni;

    state.startTime = Date.now();
    state.timerInterval = setInterval(updateTimer, 1000);
    renderPhase1();

    // Captura biom√©trica ‚Äî comienza al iniciar el juego
    if (typeof biomet !== 'undefined') {
        biomet.start({ patientId: state.patientDni, gameSlug: 'daily-routine' });
    }

    // Mood check DESPU√âS de que el juego es visible
    if (typeof showPreGameChat === 'function') showPreGameChat();
}

function updateTimer() {
    const el = document.getElementById('timer-display');
    if (!el || !state.startTime) return;
    const s = Math.floor((Date.now() - state.startTime) / 1000);
    el.textContent = String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
}

// ================================================================
// PHASE 1: PHOTO GRID
// ================================================================
function renderPhase1() {
    const grid = document.getElementById('habits-grid');
    const shuffled = [...HABITS].sort(() => Math.random() - 0.5);
    grid.innerHTML = '';

    shuffled.forEach((h, i) => {
        const card = document.createElement('div');
        card.className = 'habit-card animate-in' + (h.healthy ? '' : ' unhealthy');
        card.dataset.id = h.id;
        card.style.animationDelay = (i * 0.03) + 's';
        card.onclick = () => toggleHabit(h.id);

        // Photo
        const img = document.createElement('img');
        img.className = 'habit-photo';
        img.alt = h.label;
        img.loading = 'lazy';
        img.src = h.photo;
        img.onerror = function() {
            this.style.display = 'none';
            const fb = card.querySelector('.habit-photo-fallback');
            if (fb) fb.style.display = 'flex';
        };
        card.appendChild(img);

        // Fallback
        const fb = document.createElement('div');
        fb.className = 'habit-photo-fallback';
        fb.style.setProperty('--fb-from', h.fbFrom);
        fb.style.setProperty('--fb-to', h.fbTo);
        fb.style.display = 'none';
        fb.textContent = h.emoji;
        card.appendChild(fb);

        // Overlay
        const ov = document.createElement('div');
        ov.className = 'habit-overlay';
        card.appendChild(ov);

        // Check
        const chk = document.createElement('div');
        chk.className = 'habit-check';
        chk.textContent = '‚úì';
        card.appendChild(chk);

        // Label (tiny, bottom)
        const lbl = document.createElement('div');
        lbl.className = 'habit-label';
        lbl.textContent = h.label;
        card.appendChild(lbl);

        grid.appendChild(card);
    });

    // Registrar cards como targets para biomet
    if (typeof biomet !== 'undefined') {
        setTimeout(function() {
            shuffled.forEach(function(h) {
                var el = document.querySelector('.habit-card[data-id="' + h.id + '"]');
                if (el) biomet.registerTarget(h.id, el);
            });
        }, 100);
    }
}

function toggleHabit(id) {
    const card = document.querySelector(`.habit-card[data-id="${id}"]`);
    const h = HABITS.find(x => x.id === id);
    if (!card || !h) return;

    state.totalActions++;
    const now = Date.now();
    if (state.lastActionTime && now - state.lastActionTime > 5000) state.hesitations++;
    state.lastActionTime = now;

    const selecting = !state.selected.has(id);

    if (typeof biomet !== 'undefined') {
        biomet.recordAction({
            type: selecting ? 'select_habit' : 'deselect_habit',
            target_id: id,
            correct: h.healthy ? selecting : !selecting,  // seleccionar saludable = correcto
            is_comision: !h.healthy && selecting,          // seleccionar no-saludable = comisi√≥n
            achieved_objective: null,  // se eval√∫a al finalizar fase
            plan_correct: null,        // no hay plan secuencial en fase 1
        });
    }

    if (state.selected.has(id)) {
        state.selected.delete(id);
        card.classList.remove('selected');
    } else {
        state.selected.add(id);
        card.classList.add('selected');
    }
    updatePhase1UI();
}

function updatePhase1UI() {
    const healthyCount = [...state.selected].filter(id => HABITS.find(h=>h.id===id)?.healthy).length;
    const total = state.selected.size;

    const label = document.getElementById('progress-label');
    const fill = document.getElementById('progress-fill');
    const btn = document.getElementById('btn-to-phase2');

    label.textContent = `${healthyCount} saludables seleccionadas`;
    const pct = Math.min(100, (healthyCount / HEALTHY_REQUIRED) * 100);
    fill.style.width = pct + '%';

    if (healthyCount >= HEALTHY_REQUIRED) {
        btn.disabled = false;
        btn.classList.add('ready');
        btn.textContent = `Organizar el d√≠a ‚Üí`;
    } else {
        btn.disabled = true;
        btn.classList.remove('ready');
        btn.textContent = `Seleccion√° al menos ${HEALTHY_REQUIRED} h√°bitos saludables`;
    }
}

// ================================================================
// PHASE 2: TIMELINE
// ================================================================
const SLOT_CONFIG = {
    morning: [
        {id:'m1', label:'1¬∞'}, {id:'m2', label:'2¬∞'},
        {id:'m3', label:'3¬∞'}, {id:'m4', label:'4¬∞'},
        {id:'m5', label:'5¬∞'}
    ],
    afternoon: [
        {id:'a1', label:'1¬∞'}, {id:'a2', label:'2¬∞'},
        {id:'a3', label:'3¬∞'}, {id:'a4', label:'4¬∞'},
    ],
    evening: [
        {id:'e1', label:'1¬∞'}, {id:'e2', label:'2¬∞'},
        {id:'e3', label:'3¬∞'}, {id:'e4', label:'4¬∞'},
    ]
};

function goToPhase2() {
    document.getElementById('phase1').style.display = 'none';
    document.getElementById('phase2').style.display = 'block';
    renderPhase2();
}

function renderPhase2() {
    // Pool: selected healthy habits
    const pool = document.getElementById('selected-pool');
    pool.innerHTML = '';
    const selectedHealthy = [...state.selected]
        .map(id => HABITS.find(h=>h.id===id))
        .filter(h => h && h.healthy);

    selectedHealthy.forEach(h => {
        const card = document.createElement('div');
        card.className = 'pool-card animate-in';
        card.id = 'pool-' + h.id;
        card.draggable = true;
        card.dataset.habitId = h.id;
        card.onclick = () => placeNextAvailable(h.id);
        card.ondragstart = e => { state.draggingId = h.id; e.dataTransfer.effectAllowed = 'move'; };

        const img = document.createElement('img');
        img.src = h.photo;
        img.alt = h.label;
        img.onerror = function() {
            this.style.display = 'none';
            const fb = document.createElement('div');
            fb.className = 'pool-emoji';
            fb.textContent = h.emoji;
            card.appendChild(fb);
        };
        card.appendChild(img);
        pool.appendChild(card);
    });

    // Slots
    ['morning','afternoon','evening'].forEach(phase => {
        const container = document.getElementById('slots-' + phase);
        container.innerHTML = '';
        SLOT_CONFIG[phase].forEach(s => {
            const slot = document.createElement('div');
            slot.className = 'timeline-slot';
            slot.id = 'slot-' + s.id;
            slot.dataset.slotId = s.id;
            slot.dataset.phase = phase;

            const order = document.createElement('div');
            order.className = 'slot-order';
            order.textContent = s.label;
            slot.appendChild(order);

            slot.ondragover = e => { e.preventDefault(); slot.classList.add('drop-over'); };
            slot.ondragleave = () => slot.classList.remove('drop-over');
            slot.ondrop = e => { e.preventDefault(); slot.classList.remove('drop-over'); if (state.draggingId) placeHabitInSlot(state.draggingId, s.id); state.draggingId = null; };
            slot.onclick = () => { if (!slot.classList.contains('filled')) placeNextDragging(s.id); };

            container.appendChild(slot);
        });
    });
}

function placeNextAvailable(habitId) {
    // Find first empty slot
    const allSlots = [...document.querySelectorAll('.timeline-slot:not(.filled)')];
    if (allSlots.length === 0) return;
    placeHabitInSlot(habitId, allSlots[0].dataset.slotId);
}

function placeHabitInSlot(habitId, slotId) {
    // If habit already placed somewhere, remove from that slot
    const existing = Object.keys(state.placements).find(k => state.placements[k] === habitId);
    if (existing) removeFromSlot(existing);

    // Fill slot
    const slot = document.getElementById('slot-' + slotId);
    if (!slot || slot.classList.contains('filled')) return;

    state.placements[slotId] = habitId;
    const h = HABITS.find(x => x.id === habitId);
    if (!h) return;

    slot.classList.add('filled');

    const img = document.createElement('img');
    img.src = h.photo;
    img.alt = h.label;
    img.onerror = function() {
        this.style.display = 'none';
        const fe = document.createElement('div');
        fe.className = 'slot-emoji';
        fe.textContent = h.emoji;
        slot.appendChild(fe);
    };
    slot.appendChild(img);

    const lbl = document.createElement('div');
    lbl.className = 'slot-label';
    lbl.textContent = h.label;
    slot.appendChild(lbl);

    const rmBtn = document.createElement('button');
    rmBtn.className = 'slot-remove';
    rmBtn.textContent = '‚úï';
    rmBtn.onclick = e => { e.stopPropagation(); removeFromSlot(slotId); };
    slot.appendChild(rmBtn);

    // Mark pool card as placed
    const poolCard = document.getElementById('pool-' + habitId);
    if (poolCard) poolCard.classList.add('placed');

    updatePhase2UI();
}

function removeFromSlot(slotId) {
    const slot = document.getElementById('slot-' + slotId);
    if (!slot) return;
    const habitId = state.placements[slotId];
    delete state.placements[slotId];
    slot.classList.remove('filled');
    // Remove everything except slot-order
    [...slot.children].forEach(c => { if (!c.classList.contains('slot-order')) c.remove(); });

    if (habitId) {
        const poolCard = document.getElementById('pool-' + habitId);
        if (poolCard) poolCard.classList.remove('placed');
    }
    updatePhase2UI();
}

function updatePhase2UI() {
    const placed = Object.keys(state.placements).length;
    const btn = document.getElementById('btn-finish');
    if (placed >= 6) {
        btn.disabled = false;
        btn.classList.add('ready');
    } else {
        btn.disabled = true;
        btn.classList.remove('ready');
    }
}

// ================================================================
// FINISH & SCORE
// ================================================================
function finishGame() {
    clearInterval(state.timerInterval);
    document.getElementById('phase2').style.display = 'none';
    document.getElementById('results').style.display = 'block';

    const totalTime = Math.floor((Date.now() - state.startTime) / 1000);
    const healthySelected = [...state.selected].filter(id => HABITS.find(h=>h.id===id)?.healthy).length;
    const unhealthySelected = [...state.selected].filter(id => !HABITS.find(h=>h.id===id)?.healthy).length;
    const placedCount = Object.keys(state.placements).length;

    // Score
    const selScore = Math.min(100, (healthySelected / 15) * 40);
    const placedScore = Math.min(100, (placedCount / 8) * 35);
    const penaltyScore = Math.max(0, 25 - (unhealthySelected * 5));
    const total = Math.round(selScore + placedScore + penaltyScore);

    // Clinical vectors
    const sequenceScore = calcSequenceCoherence();

    const metrics = {
        healthy_selected: healthySelected,
        unhealthy_selected: unhealthySelected,
        placed_count: placedCount,
        total_actions: state.totalActions,
        hesitations: state.hesitations,
        duration_seconds: totalTime,
        sequence_coherence: sequenceScore,
        final_score: total
    };

    // Biomet: guardar m√©tricas psicomotoras capturadas durante el juego
    let biometData = {};
    if (typeof biomet !== 'undefined') {
        biometData = biomet.save({
            final_score: total,
            selection_score: Math.round(selScore),
            sequence_score: Math.round(sequenceScore)
        });
    }

    saveResults(metrics, biometData);

    document.getElementById('results-content').innerHTML = `
        <div class="score-circle">${total}</div>
        <h2 style="margin-bottom:20px;">Rutina completada</h2>
        <div class="result-row">
            <span>H√°bitos saludables identificados</span>
            <span style="color:#a78bfa;font-weight:700">${healthySelected} / ${HABITS.filter(h=>h.healthy).length}</span>
        </div>
        <div class="result-row">
            <span>Actividades organizadas en el d√≠a</span>
            <span style="color:#a78bfa;font-weight:700">${placedCount}</span>
        </div>
        <div class="result-row">
            <span>Tiempo total</span>
            <span style="color:#94a3b8">${Math.floor(totalTime/60)}m ${totalTime%60}s</span>
        </div>
        <div class="result-row">
            <span>Coherencia de secuencia</span>
            <span style="color:#a78bfa;font-weight:700">${sequenceScore}%</span>
        </div>
        <button class="btn-replay" onclick="location.reload()">Jugar de nuevo</button>
    `;

    if (typeof showPostGameColorModal === 'function') showPostGameColorModal();
}

function calcSequenceCoherence() {
    let correct = 0; let total = 0;
    Object.entries(state.placements).forEach(([slotId, habitId]) => {
        const h = HABITS.find(x => x.id === habitId);
        if (!h || !h.phase) return;
        total++;
        const phase = slotId.startsWith('m') ? 'morning' : slotId.startsWith('a') ? 'afternoon' : 'evening';
        if (h.phase === phase) correct++;
    });
    return total === 0 ? 0 : Math.round((correct / total) * 100);
}

async function saveResults(metrics, biometData) {
    if (!supabase) return;
    try {
        // Get patient UUID from DNI first
        let dailyPatientId = null;
        try {
            const { data: pdata } = await supabase.from('hdd_patients').select('id').eq('dni', state.patientDni).single();
            if (pdata) dailyPatientId = pdata.id;
        } catch(e) {}

        supabase.from('hdd_game_metrics').insert({
            patient_id: dailyPatientId,
            game_slug: 'daily-routine-v2',
            metric_type: 'session_complete',
            metric_value: metrics.final_score,
            metric_data: {
                ...metrics,
                biomet: biometData || {},
                game_name: 'Mi Rutina Diaria',
                input_device: (navigator.maxTouchPoints > 0 && 'ontouchstart' in window) ? 'touch' : 'mouse',
                completed: true
            },
            created_at: new Date().toISOString()
        }).then(()=>{}).catch(()=>{});

        // Save full biometric data to Supabase Storage bucket 'biometricas'
        if (dailyPatientId) {
            fetch('/api/biometricas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id: dailyPatientId,
                    session_id: 'dailyroutine-' + Date.now(),
                    game_slug: 'daily-routine-v2',
                    biometric_data: { ...metrics, biomet: biometData || {}, game_name: 'Mi Rutina Diaria' }
                })
            }).catch(e => console.warn('[daily-routine] Bucket save fail:', e.message));
        }
    } catch(e) {}
}

// Back link
(function(){
    var p = (function(){try{return localStorage.getItem('games_session')}catch(e){return null}})();
    var l = document.getElementById('back-link');
    if (l) l.href = p ? '/games/portal/' : '/hdd/portal/';
})();
</script>

<script src="/games/shared/mood-modals.js"></script>
<script>if (typeof initMoodModals === 'function') initMoodModals();</script>
</body>
</html>
