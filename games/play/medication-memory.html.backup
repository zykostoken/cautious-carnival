<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memoria de Medicacion - Hospital de Dia</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --secondary-light: #d1fae5;
      --background: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --error: #ef4444;
      --error-light: #fee2e2;
      --success: #22c55e;
      --success-light: #dcfce7;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-sm: 8px;
    }

    @font-face {
      font-family: 'Prescription';
      src: local('Segoe Script'), local('Comic Sans MS'), local('Brush Script MT'), local('cursive');
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .game-header {
      background: var(--surface);
      border-bottom: 2px solid var(--primary);
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1100px;
      margin: 0 auto;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.8rem;
      background: var(--primary-light);
      color: var(--primary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: var(--primary); color: white; }

    .game-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }
    .game-title small {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .header-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-badge {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.7rem;
      background: var(--background);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    .stat-badge .value { color: var(--text); }
    .stat-badge.timer { color: var(--primary); }
    .stat-badge.timer.warning { color: var(--warning); animation: pulse-warn 0.5s infinite alternate; }
    .stat-badge.timer.critical { color: var(--error); animation: pulse-warn 0.3s infinite alternate; }

    @keyframes pulse-warn {
      to { transform: scale(1.08); }
    }

    /* Main Container */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Screen transitions */
    .screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    .screen.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ====== LEVEL SELECT ====== */
    .level-select-title {
      text-align: center;
      margin: 2rem 0 0.5rem;
      font-size: 1.8rem;
      color: var(--text);
    }
    .level-select-subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 2rem;
      font-size: 1rem;
    }

    .therapeutic-areas {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 2.5rem;
    }
    .area-tag {
      padding: 0.35rem 0.75rem;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .levels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      max-width: 700px;
      margin: 0 auto;
    }

    .level-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
      overflow: hidden;
    }
    .level-card:hover:not(.locked) {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }
    .level-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .level-card.locked::after {
      content: '';
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 24px;
      height: 24px;
      background: var(--text-muted);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'/%3E%3C/svg%3E") center/contain no-repeat;
    }

    .level-number {
      width: 48px;
      height: 48px;
      margin: 0 auto 0.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 800;
      color: white;
    }
    .level-card:nth-child(1) .level-number { background: var(--secondary); }
    .level-card:nth-child(2) .level-number { background: var(--primary); }
    .level-card:nth-child(3) .level-number { background: #8b5cf6; }
    .level-card:nth-child(4) .level-number { background: #f59e0b; }
    .level-card:nth-child(5) .level-number { background: var(--error); }

    .level-name {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .level-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .level-meta {
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: center;
      gap: 0.75rem;
    }
    .level-meta span { display: flex; align-items: center; gap: 0.2rem; }

    .level-best {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--secondary);
      font-weight: 600;
    }

    /* ====== PRESCRIPTION PHASE ====== */
    .prescription-phase {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
    }

    .phase-instruction {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 500;
    }

    .countdown-circle {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
      position: relative;
    }
    .countdown-circle svg {
      transform: rotate(-90deg);
      width: 80px;
      height: 80px;
    }
    .countdown-circle .track {
      fill: none;
      stroke: var(--border);
      stroke-width: 6;
    }
    .countdown-circle .progress {
      fill: none;
      stroke: var(--primary);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear, stroke 0.3s;
    }
    .countdown-circle .time-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--primary);
    }

    .prescription-paper {
      background: #fffef5;
      border: 1px solid #d4c89a;
      border-radius: 4px;
      padding: 2rem 2.25rem;
      max-width: 560px;
      width: 100%;
      box-shadow: 2px 3px 15px rgba(0,0,0,0.12), inset 0 0 40px rgba(200,190,150,0.1);
      position: relative;
      transform: rotate(-0.8deg);
      transition: all 0.6s ease;
    }
    .prescription-paper.fade-out {
      opacity: 0;
      transform: rotate(-2deg) scale(0.9) translateY(-20px);
    }
    .prescription-paper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 30px;
      right: 30px;
      height: 3px;
      background: var(--primary);
    }

    .rx-header {
      text-align: center;
      border-bottom: 1px solid #c8b87a;
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
    }
    .rx-doctor {
      font-family: 'Segoe Script', 'Comic Sans MS', 'Brush Script MT', cursive;
      font-size: 1.15rem;
      color: #2c3e50;
      font-weight: 700;
    }
    .rx-mat {
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }
    .rx-specialty {
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 500;
    }

    .rx-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px dashed #d4c89a;
    }

    .rx-symbol {
      font-family: 'Segoe Script', 'Comic Sans MS', 'Brush Script MT', cursive;
      font-size: 2rem;
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .rx-items {
      list-style: none;
      padding: 0;
    }
    .rx-item {
      padding: 0.6rem 0;
      border-bottom: 1px dotted #e0d9b8;
      font-family: 'Segoe Script', 'Comic Sans MS', 'Brush Script MT', cursive;
      font-size: 1rem;
      color: #1a1a2e;
      line-height: 1.5;
    }
    .rx-item:last-child { border-bottom: none; }
    .rx-item .med-name-rx {
      font-weight: 700;
      color: #1a365d;
    }
    .rx-item .med-dose-rx {
      color: #4a5568;
    }
    .rx-item .med-note {
      display: block;
      font-size: 0.85rem;
      color: var(--error);
      font-style: italic;
      margin-top: 0.15rem;
    }

    .rx-signature {
      margin-top: 1.5rem;
      text-align: right;
      font-family: 'Segoe Script', 'Comic Sans MS', 'Brush Script MT', cursive;
      color: #2c3e50;
      font-size: 1.1rem;
      border-top: 1px solid #c8b87a;
      padding-top: 0.75rem;
    }
    .rx-signature-line {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* ====== TRANSITION ====== */
    .transition-message {
      text-align: center;
      padding: 4rem 1rem;
      animation: fadeIn 0.5s ease;
    }
    .transition-icon {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      display: block;
    }
    .transition-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    .transition-sub {
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* ====== DESK PHASE ====== */
    .desk-phase { animation: fadeIn 0.5s ease; }

    .desk-instruction {
      text-align: center;
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .desk-timer-bar {
      display: none; /* response timer is in header */
    }

    /* med-grid and med-card styles are in pharmacy vitrina section below */

    .med-card-header {
      padding: 0.5rem 0.65rem;
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .med-card-header .pill-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .med-card-body {
      padding: 0.75rem 0.65rem;
    }
    .med-card-name {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--text);
      margin-bottom: 0.2rem;
      line-height: 1.3;
    }
    .med-card-dosage {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    .med-card-form {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }
    .med-card-check {
      display: none;
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      width: 22px;
      height: 22px;
      background: var(--secondary);
      border-radius: 50%;
      color: white;
      font-size: 0.75rem;
      align-items: center;
      justify-content: center;
    }
    .med-card.selected { position: relative; }
    .med-card.selected .med-card-check { display: flex; }

    /* Category colors */
    .cat-antipsicotico { background: #7c3aed; }
    .cat-ansiolitico { background: #0891b2; }
    .cat-antidepresivo { background: #059669; }
    .cat-estabilizador { background: #d97706; }
    .cat-anticolinergico { background: #be185d; }
    .cat-otro { background: #6366f1; }

    /* tray-section styles are in pastillero section below */
    .tray-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .tray-title svg { width: 18px; height: 18px; color: var(--primary); }

    .tray-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 1rem;
      font-style: italic;
    }

    .tray-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .tray-item {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .tray-item-name {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text);
      min-width: 140px;
    }
    .tray-item-dosage-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tray-item-config {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      flex: 1;
    }

    .config-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .config-group label {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
    }
    .config-group select {
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      background: white;
      color: var(--text);
      cursor: pointer;
      min-width: 100px;
    }
    .config-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .tray-item-remove {
      margin-left: auto;
      width: 28px;
      height: 28px;
      border: none;
      background: var(--error-light);
      color: var(--error);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .tray-item-remove:hover {
      background: var(--error);
      color: white;
    }

    /* Confirm button */
    .confirm-section {
      text-align: center;
      margin: 1.5rem 0;
    }
    .confirm-btn {
      padding: 0.85rem 2.5rem;
      font-size: 1rem;
      font-weight: 700;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-md);
    }
    .confirm-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    .confirm-btn:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ====== RESULTS MODAL ====== */
    .results-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeInOverlay 0.3s ease;
    }
    .results-overlay.active { display: flex; }

    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .results-modal {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
      padding: 1.5rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .results-score {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }
    .results-max { color: var(--text-muted); font-size: 1rem; font-weight: 400; }
    .results-label {
      font-size: 1rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .results-stars {
      font-size: 1.5rem;
      margin-top: 0.5rem;
      letter-spacing: 4px;
    }
    .star-filled { color: #f59e0b; }
    .star-empty { color: var(--border); }

    .results-body { padding: 1.25rem 1.5rem; }

    .results-breakdown {
      list-style: none;
      padding: 0;
    }
    .results-breakdown li {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .results-breakdown li:last-child { border-bottom: none; }

    .result-icon {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .result-icon.correct { background: var(--success-light); color: var(--success); }
    .result-icon.wrong { background: var(--error-light); color: var(--error); }
    .result-icon.missed { background: var(--warning-light); color: var(--warning); }
    .result-icon.bonus { background: var(--primary-light); color: var(--primary); }

    .result-detail { flex: 1; color: var(--text); }
    .result-points {
      font-weight: 700;
      min-width: 55px;
      text-align: right;
    }
    .result-points.positive { color: var(--success); }
    .result-points.negative { color: var(--error); }
    .result-points.neutral { color: var(--primary); }

    .results-footer {
      padding: 1rem 1.5rem;
      display: flex;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .results-footer button {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-retry {
      background: var(--background);
      color: var(--text);
      border: 1px solid var(--border) !important;
    }
    .btn-retry:hover { background: var(--border); }
    .btn-next {
      background: var(--primary);
      color: white;
    }
    .btn-next:hover { background: var(--primary-dark); }
    .btn-back-portal {
      background: var(--secondary);
      color: white;
    }
    .btn-back-portal:hover { background: var(--secondary-dark); }

    /* Mobile adjustments */
    @media (max-width: 640px) {
      .header-content { font-size: 0.85rem; }
      .game-title { font-size: 0.95rem; }
      .game-title small { display: none; }
      .stat-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
      .level-select-title { font-size: 1.4rem; }
      .levels-grid { grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 0.75rem; }
      .med-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.5rem; }
      .prescription-paper { padding: 1.25rem 1.5rem; }
      .rx-item { font-size: 0.9rem; }
      .tray-item { flex-direction: column; align-items: flex-start; }
      .tray-item-config { width: 100%; }
      .tray-item-remove { align-self: flex-end; margin-left: 0; }
      .config-group select { min-width: 85px; }
      .results-footer { flex-direction: column; }
    }

    /* Utility */
    .hidden { display: none !important; }
    .text-center { text-align: center; }

    /* ====== PHARMACY VITRINA THEME ====== */
    .med-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(180deg, rgba(200,220,240,0.15) 0%, rgba(200,220,240,0.05) 100%);
      border: 3px solid #94a3b8;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
    }
    .med-grid::before {
      content: 'VITRINA DE FARMACIA';
      position: absolute;
      top: -12px;
      left: 20px;
      background: var(--surface);
      padding: 0 10px;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 1.5px;
    }

    .med-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      user-select: none;
      transform: perspective(400px) rotateX(2deg);
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    }
    .med-card:hover:not(.selected) {
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(37,99,235,0.15);
      transform: perspective(400px) rotateX(0deg) translateY(-4px);
    }
    .med-card.selected {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px var(--secondary-light), 0 0 15px rgba(16,185,129,0.2);
      transform: perspective(400px) rotateX(0deg) scale(1.02);
    }
    .med-card.selected .med-card-header {
      background: var(--secondary) !important;
    }

    /* Pastillero tray theme */
    .tray-section {
      background: linear-gradient(135deg, #f0f9ff 0%, #e8f4f8 100%);
      border: 3px solid #7dd3fc;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      min-height: 80px;
      position: relative;
    }
    .tray-section::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 15%;
      right: 15%;
      height: 4px;
      background: linear-gradient(90deg, transparent, #38bdf8, transparent);
      border-radius: 0 0 4px 4px;
    }

    /* ====== BONUS LEVEL STYLES ====== */
    .bonus-area {
      min-height: 400px;
      position: relative;
      padding: 1rem;
    }
    .bonus-instruction {
      text-align: center;
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    /* Drag pills bonus */
    .pastillero-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 500px;
      margin: 0 auto 1.5rem;
      background: #e0f2fe;
      border: 3px solid #38bdf8;
      border-radius: 16px;
      padding: 12px;
    }
    .pastillero-slot {
      background: white;
      border: 2px dashed #94a3b8;
      border-radius: 12px;
      padding: 0.75rem 0.5rem;
      text-align: center;
      min-height: 80px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    .pastillero-slot.drag-over {
      background: #dcfce7;
      border-color: var(--secondary);
      border-style: solid;
    }
    .pastillero-slot.filled {
      background: #f0fdf4;
      border-color: var(--secondary);
      border-style: solid;
    }
    .pastillero-slot .slot-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .pastillero-slot .slot-time {
      font-size: 0.65rem;
      color: var(--primary);
    }
    .pastillero-slot .slot-pill-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--secondary-dark);
    }

    .drag-pills-area {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      padding: 1rem;
    }
    .draggable-pill {
      width: 80px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
      cursor: grab;
      user-select: none;
      touch-action: none;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      text-align: center;
      line-height: 1.1;
      padding: 0 6px;
    }
    .draggable-pill:active { cursor: grabbing; }
    .draggable-pill.dragging {
      opacity: 0.8;
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      position: fixed;
      pointer-events: none;
    }

    /* Count drops bonus */
    .drops-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem;
    }
    .drops-bottle {
      width: 100px;
      height: 160px;
      background: linear-gradient(180deg, #dbeafe 0%, #93c5fd 40%, #3b82f6 100%);
      border-radius: 15px 15px 25px 25px;
      position: relative;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .drops-bottle::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 30px;
      width: 40px;
      height: 25px;
      background: #94a3b8;
      border-radius: 5px 5px 0 0;
    }
    .drops-bottle:active { transform: scale(0.95); }
    .drops-bottle .bottle-label {
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      text-align: center;
      padding: 0 10px;
    }

    .drops-target {
      width: 120px;
      height: 50px;
      background: linear-gradient(180deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      border-radius: 8px 8px 25px 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      color: #92400e;
      position: relative;
    }

    .drops-counter {
      font-size: 3rem;
      font-weight: 800;
      color: var(--primary);
    }
    .drops-target-label {
      font-size: 1rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    .drop-animation {
      position: absolute;
      width: 12px;
      height: 16px;
      background: #3b82f6;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      animation: dropFall 0.5s ease-in forwards;
    }
    @keyframes dropFall {
      from { top: -30px; opacity: 1; }
      to { top: 30px; opacity: 0; }
    }

    .drops-confirm-btn {
      padding: 0.75rem 2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .drops-confirm-btn:hover { background: var(--primary-dark); }

    /* ====== LEVEL CARD BONUS STYLE ====== */
    .level-card.bonus-card {
      border-color: #f59e0b;
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
    }
    .level-card.bonus-card .level-number {
      background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    }
    .level-card.bonus-card .level-name {
      color: #92400e;
    }

    /* ====== PSYCHOEDUCATION TIP ====== */
    .psychoedu-tip {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 1px solid #93c5fd;
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      margin-top: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      max-width: 560px;
      width: 100%;
    }
    .psychoedu-tip .tip-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }
    .psychoedu-tip .tip-text {
      font-size: 0.85rem;
      color: #1e40af;
      line-height: 1.5;
    }

    .results-psychoedu {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 1px solid #86efac;
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: #166534;
      line-height: 1.5;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    /* ====== METRICS OVERLAY ====== */
    .metrics-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      overflow-y: auto;
      padding: 1rem;
    }
    .metrics-overlay.active { display: block; }

    .metrics-panel {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 800px;
      margin: 1rem auto;
      padding: 1.5rem;
      box-shadow: var(--shadow-xl);
    }
    .metrics-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .metrics-panel-title {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .metrics-close-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--background);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .metrics-close-btn:hover { background: var(--error-light); color: var(--error); }

    .metrics-charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .chart-box {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
    }
    .chart-box h4 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    .chart-box canvas {
      width: 100%;
      height: 150px;
    }

    .fda-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .fda-metric {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
      text-align: center;
    }
    .fda-metric .metric-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
    }
    .fda-metric .metric-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 0.2rem;
    }

    .progress-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.2rem;
      background: var(--primary-light);
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin: 1.5rem auto 0;
      display: block;
      text-align: center;
      max-width: 250px;
    }
    .progress-btn:hover { background: var(--primary); color: white; }
  </style>
  <script src="/games/shared/mood-modals.js"></script>
</head>
<body>

<!-- HEADER -->
<header class="game-header">
  <div class="header-content">
    <div class="header-left">
      <a class="back-btn" id="backBtn" href="/games/portal">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Volver
      </a>
      <span class="game-title">Memoria de Medicacion <small>- Hospital de Dia</small></span>
      <span class="demo-badge" id="demoBadge" style="display:none; background:#f59e0b; color:#fff; padding:0.2rem 0.5rem; border-radius:4px; font-size:0.75rem; font-weight:600; margin-left:0.5rem;">MODO DEMO</span>
    </div>
    <div class="header-stats">
      <div class="stat-badge" id="levelBadge" style="display:none;">
        <span>Nivel</span>
        <span class="value" id="levelValue">1</span>
      </div>
      <div class="stat-badge" id="scoreBadge" style="display:none;">
        <span>Puntos</span>
        <span class="value" id="scoreValue">0</span>
      </div>
      <div class="stat-badge timer" id="timerBadge" style="display:none;">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        <span class="value" id="timerValue">--</span>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- SCREEN: Level Select -->
  <div id="screenLevelSelect" class="screen active">
    <h1 class="level-select-title">Memoria de Medicacion</h1>
    <p class="level-select-subtitle">Memorizá la receta y armá la medicacion correcta</p>

    <div class="therapeutic-areas">
      <span class="area-tag">Memoria de trabajo</span>
      <span class="area-tag">Atencion al detalle</span>
      <span class="area-tag">Comprension lectora</span>
      <span class="area-tag">Responsabilidad terapeutica</span>
    </div>

    <div class="levels-grid" id="levelsGrid"></div>

    <button class="progress-btn" id="showProgressBtn">Ver Progreso Terapeutico</button>
  </div>

  <!-- SCREEN: Prescription Phase -->
  <div id="screenPrescription" class="screen">
    <div class="prescription-phase">
      <p class="phase-instruction">Memorizá la receta medica. Tené en cuenta los medicamentos, dosis y frecuencias.</p>

      <div class="countdown-circle" id="countdownCircle">
        <svg viewBox="0 0 80 80">
          <circle class="track" cx="40" cy="40" r="35"/>
          <circle class="progress" id="countdownProgress" cx="40" cy="40" r="35"
            stroke-dasharray="219.91" stroke-dashoffset="0"/>
        </svg>
        <div class="time-text" id="countdownText">--</div>
      </div>

      <div class="prescription-paper" id="prescriptionPaper">
        <div class="rx-header">
          <div class="rx-doctor" id="rxDoctor">Dr. Martinez Fernandez</div>
          <div class="rx-mat" id="rxMat">Mat. 12345 - M.N.</div>
          <div class="rx-specialty">Psiquiatria</div>
        </div>
        <div class="rx-info">
          <span id="rxDate">Fecha: 29/01/2026</span>
          <span>Paciente: <strong>[Paciente]</strong></span>
        </div>
        <div class="rx-symbol">Rp/</div>
        <ul class="rx-items" id="rxItems"></ul>
        <div class="rx-signature">
          <span id="rxSigName">Dr. Martinez F.</span>
          <span class="rx-signature-line">Firma y Sello</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN: Transition -->
  <div id="screenTransition" class="screen">
    <div class="transition-message">
      <span class="transition-icon">&#128138;</span>
      <div class="transition-text">Armá tu medicacion del dia</div>
      <div class="transition-sub">Seleccioná los medicamentos correctos y configurá las dosis</div>
      <div id="transitionTip"></div>
    </div>
  </div>

  <!-- SCREEN: Bonus Level (drag pills / count drops) -->
  <div id="screenBonus" class="screen">
    <div class="bonus-area" id="bonusArea">
      <p class="bonus-instruction" id="bonusInstruction"></p>
      <div id="bonusContent"></div>
      <div class="confirm-section">
        <button class="confirm-btn" id="bonusConfirmBtn">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- SCREEN: Desk Phase -->
  <div id="screenDesk" class="screen">
    <p class="desk-instruction">Seleccioná los medicamentos de la receta y configurá las dosis correctas.</p>

    <div class="med-grid" id="medGrid"></div>

    <div class="tray-section">
      <div class="tray-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v3"/></svg>
        Bandeja de medicacion
      </div>
      <div id="trayContent">
        <div class="tray-empty" id="trayEmpty">Hacé clic en los medicamentos de arriba para agregarlos a tu bandeja</div>
        <div class="tray-items" id="trayItems"></div>
      </div>
    </div>

    <div class="confirm-section">
      <button class="confirm-btn" id="confirmBtn" disabled>Confirmar medicacion</button>
    </div>
  </div>

  <!-- SCREEN: Results (overlay) -->
  <div class="results-overlay" id="resultsOverlay">
    <div class="results-modal">
      <div class="results-header">
        <div class="results-score" id="resultsScore">0</div>
        <div class="results-max" id="resultsMax">/ 0</div>
        <div class="results-label">puntos obtenidos</div>
        <div class="results-stars" id="resultsStars"></div>
      </div>
      <div class="results-body">
        <ul class="results-breakdown" id="resultsBreakdown"></ul>
        <div id="resultsPsychoedu"></div>
      </div>
      <div class="results-footer" id="resultsFooter"></div>
    </div>
  </div>
</div>

<!-- METRICS OVERLAY (outside container) -->
<div class="metrics-overlay" id="metricsOverlay">
  <div class="metrics-panel">
    <div class="metrics-panel-header">
      <h2 class="metrics-panel-title">Progreso Terapeutico</h2>
      <button class="metrics-close-btn" id="metricsCloseBtn">&times;</button>
    </div>
    <div class="fda-summary" id="fdaSummary"></div>
    <div class="metrics-charts-grid" id="metricsChartsGrid">
      <div class="chart-box">
        <h4>Memoria (items recordados)</h4>
        <canvas id="chartMemory" width="340" height="150"></canvas>
      </div>
      <div class="chart-box">
        <h4>Velocidad de Decision (ms)</h4>
        <canvas id="chartSpeed" width="340" height="150"></canvas>
      </div>
      <div class="chart-box">
        <h4>Adherencia Simulada (MPR)</h4>
        <canvas id="chartMPR" width="340" height="150"></canvas>
      </div>
      <div class="chart-box">
        <h4>Errores (omision vs comision)</h4>
        <canvas id="chartErrors" width="340" height="150"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ==================== MEDICATION DATABASE ====================
  const MEDICATIONS = [
    { name: 'Risperidona', dosages: ['0.5mg','1mg','2mg','3mg'], form: 'comprimidos', category: 'antipsicotico' },
    { name: 'Clonazepam', dosages: ['0.25mg','0.5mg','1mg','2mg'], form: 'comprimidos', category: 'ansiolitico' },
    { name: 'Quetiapina', dosages: ['25mg','100mg','200mg','300mg'], form: 'comprimidos', category: 'antipsicotico' },
    { name: 'Sertralina', dosages: ['25mg','50mg','100mg'], form: 'comprimidos', category: 'antidepresivo' },
    { name: 'Carbonato de Litio', dosages: ['300mg','450mg'], form: 'comprimidos', category: 'estabilizador' },
    { name: 'Valproato', dosages: ['250mg','500mg'], form: 'comprimidos', category: 'estabilizador' },
    { name: 'Haloperidol', dosages: ['1mg','5mg'], form: 'comprimidos', category: 'antipsicotico' },
    { name: 'Biperideno', dosages: ['2mg','4mg'], form: 'comprimidos', category: 'anticolinergico' },
    { name: 'Melatonina', dosages: ['3mg','5mg'], form: 'comprimidos', category: 'otro' },
    { name: 'Olanzapina', dosages: ['5mg','10mg'], form: 'comprimidos', category: 'antipsicotico' },
    { name: 'Carbamazepina', dosages: ['200mg','400mg'], form: 'comprimidos', category: 'estabilizador' },
    { name: 'Lorazepam', dosages: ['1mg','2mg'], form: 'comprimidos', category: 'ansiolitico' }
  ];

  const QUANTITIES = [
    { value: '1/4', label: '1/4 comp' },
    { value: '1/2', label: '1/2 comp' },
    { value: '1', label: '1 comp' },
    { value: '1+1/2', label: '1 y 1/2 comp' },
    { value: '2', label: '2 comp' }
  ];

  const FREQUENCIES = [
    { value: 'maniana', label: 'Maniana' },
    { value: 'mediodia', label: 'Mediodia' },
    { value: 'noche', label: 'Noche' },
    { value: 'maniana-noche', label: 'Maniana y Noche' },
    { value: 'maniana-mediodia-noche', label: 'Man/Med/Noche' },
    { value: 'con-comida', label: 'Con comida' },
    { value: 'en-ayunas', label: 'En ayunas' }
  ];

  const DOCTOR_NAMES = [
    'Dra. Silvina Martinez', 'Dr. Carlos Fernandez', 'Dra. Laura Gonzalez',
    'Dr. Ricardo Mendez', 'Dra. Claudia Pereyra', 'Dr. Andres Ruiz'
  ];

  const NOTES_POOL = [
    'No tomar con jugo de pomelo',
    'Tomar con abundante agua',
    'No combinar con alcohol',
    'Controlar presion arterial semanalmente',
    'Realizar litemia cada 15 dias'
  ];

  // ==================== PSYCHOEDUCATION ====================
  const PSYCHOEDU_TIPS = {
    transition: [
      { maxLevel: 3, tips: [
        'Los medicamentos psiquiatricos necesitan tomarse todos los dias para mantener niveles estables en sangre.',
        'La constancia en la toma es mas importante que la hora exacta. Elegí un momento del dia que te resulte facil recordar.',
        'Si olvidás una dosis, no dupliques la siguiente. Consultá con tu medico.'
      ]},
      { maxLevel: 7, tips: [
        'Un pastillero semanal reduce errores de medicacion hasta un 70%. Es una herramienta simple y muy efectiva.',
        'Cada medicamento tiene una "ventana terapeutica": la dosis minima que hace efecto y la maxima segura.',
        'Las interacciones entre medicamentos son comunes. Siempre informá a tu medico todo lo que tomás.'
      ]},
      { maxLevel: 12, tips: [
        'Algunos medicamentos necesitan controles periodicos (analisis de sangre, presion). No los saltees.',
        'Los efectos adversos suelen aparecer al inicio y disminuir con el tiempo. Paciencia y comunicacion con tu medico.',
        'No suspendas la medicacion porque "ya te sentis bien". Eso es justamente señal de que está funcionando.'
      ]},
      { maxLevel: 999, tips: [
        'La adherencia perfecta no existe. Lo importante es mantener una rutina lo mas consistente posible.',
        'Involucrar a un familiar o amigo como "recordatorio humano" mejora la adherencia significativamente.',
        'Las apps de recordatorio pueden ayudar, pero la mejor alarma es la que ya tenés: asociá la toma a una actividad diaria (desayuno, cepillado de dientes).'
      ]}
    ],
    errorFeedback: {
      missed: 'Olvidar un medicamento puede causar sintomas de rebote o recaida. Un pastillero y alarmas ayudan a no olvidar.',
      wrongDose: 'La dosis correcta es clave: muy poco no hace efecto, demasiado puede causar efectos adversos. Siempre verificá.',
      wrongFreq: 'La frecuencia mantiene niveles estables en sangre. Tomarlos a destiempo reduce su efectividad.',
      wrongMed: 'Confundir medicamentos es un riesgo real. Guardalos en lugares separados y etiquetados.',
      perfect: 'Excelente memoria y precision. La adherencia terapeutica es fundamental para la recuperacion.'
    }
  };

  function getPsychoeduTip(levelId) {
    const group = PSYCHOEDU_TIPS.transition.find(g => levelId <= g.maxLevel);
    if (!group) return '';
    return pickRandom(group.tips);
  }

  function getErrorFeedback(results) {
    if (results.allPerfect) return PSYCHOEDU_TIPS.errorFeedback.perfect;
    if (results.missedMeds > 0) return PSYCHOEDU_TIPS.errorFeedback.missed;
    if (results.wrongMeds > 0) return PSYCHOEDU_TIPS.errorFeedback.wrongMed;
    // Check for dose/freq errors from breakdown
    const hasDoseErr = results.breakdown.some(b => b.text.includes('dosis incorrecta'));
    const hasFreqErr = results.breakdown.some(b => b.text.includes('frecuencia incorrecta'));
    if (hasDoseErr) return PSYCHOEDU_TIPS.errorFeedback.wrongDose;
    if (hasFreqErr) return PSYCHOEDU_TIPS.errorFeedback.wrongFreq;
    return PSYCHOEDU_TIPS.errorFeedback.perfect;
  }

  // ==================== LEVEL DEFINITIONS ====================
  // mechanic: 'name-only' = just identify correct med names
  //           'name-and-dose' = identify med + correct dosage (same-name distractors)
  //           'full-config' = identify + configure dose + frequency in tray
  // type: 'regular' (default) or 'bonus' (motor skill challenge)
  // bonusType: 'drag-pills' or 'count-drops' (only for bonus levels)
  const LEVELS = [
    {
      id: 1, name: 'Tutorial', desc: 'Identifica 1 medicamento por nombre',
      medCount: 1, viewTime: 25, optionCount: 4, mechanic: 'name-only',
      splitDose: false, timing: false, notes: false, unlocked: true
    },
    {
      id: 2, name: 'Basico I', desc: '1 medicamento, identifica la dosis correcta',
      medCount: 1, viewTime: 20, optionCount: 5, mechanic: 'name-and-dose',
      splitDose: false, timing: false, notes: false, unlocked: false
    },
    {
      id: 3, name: 'Basico II', desc: '1 medicamento, configura dosis y frecuencia',
      medCount: 1, viewTime: 18, optionCount: 4, mechanic: 'full-config',
      splitDose: false, timing: false, notes: false, unlocked: false
    },
    {
      id: 4, name: 'Intermedio I', desc: '2 medicamentos, solo nombres',
      medCount: 2, viewTime: 15, optionCount: 6, mechanic: 'name-only',
      splitDose: false, timing: false, notes: false, unlocked: false
    },
    {
      id: 100, name: 'Bonus: Pastillero', desc: 'Arrastra las pastillas al compartimiento correcto',
      medCount: 2, viewTime: 15, optionCount: 0, mechanic: 'full-config',
      splitDose: false, timing: false, notes: false, unlocked: false,
      type: 'bonus', bonusType: 'drag-pills'
    },
    {
      id: 5, name: 'Intermedio II', desc: '2 medicamentos, configuracion completa',
      medCount: 2, viewTime: 15, optionCount: 5, mechanic: 'full-config',
      splitDose: false, timing: false, notes: false, unlocked: false
    },
    {
      id: 6, name: 'Intermedio III', desc: '2 medicamentos, dosis divididas',
      medCount: 2, viewTime: 12, optionCount: 6, mechanic: 'full-config',
      splitDose: true, timing: false, notes: false, unlocked: false
    },
    {
      id: 7, name: 'Avanzado I', desc: '3 medicamentos, identifica dosis',
      medCount: 3, viewTime: 12, optionCount: 8, mechanic: 'name-and-dose',
      splitDose: true, timing: false, notes: false, unlocked: false
    },
    {
      id: 8, name: 'Avanzado II', desc: '3 medicamentos, configuracion completa',
      medCount: 3, viewTime: 10, optionCount: 7, mechanic: 'full-config',
      splitDose: true, timing: false, notes: false, unlocked: false
    },
    {
      id: 101, name: 'Bonus: Cuenta Gotas', desc: 'Conta las gotas correctas para cada medicamento',
      medCount: 1, viewTime: 10, optionCount: 0, mechanic: 'full-config',
      splitDose: false, timing: false, notes: false, unlocked: false,
      type: 'bonus', bonusType: 'count-drops'
    },
    {
      id: 9, name: 'Avanzado III', desc: '3 medicamentos, mas distractores',
      medCount: 3, viewTime: 10, optionCount: 8, mechanic: 'full-config',
      splitDose: true, timing: false, notes: false, unlocked: false
    },
    {
      id: 10, name: 'Experto I', desc: '4 medicamentos basicos',
      medCount: 4, viewTime: 10, optionCount: 8, mechanic: 'full-config',
      splitDose: true, timing: false, notes: false, unlocked: false
    },
    {
      id: 11, name: 'Experto II', desc: '4 medicamentos con horarios',
      medCount: 4, viewTime: 10, optionCount: 9, mechanic: 'full-config',
      splitDose: true, timing: true, notes: false, unlocked: false
    },
    {
      id: 102, name: 'Bonus: Pastillero', desc: 'Arma el pastillero semanal con 3 medicamentos',
      medCount: 3, viewTime: 12, optionCount: 0, mechanic: 'full-config',
      splitDose: true, timing: false, notes: false, unlocked: false,
      type: 'bonus', bonusType: 'drag-pills'
    },
    {
      id: 12, name: 'Experto III', desc: '4 medicamentos, tiempo ajustado',
      medCount: 4, viewTime: 8, optionCount: 9, mechanic: 'full-config',
      splitDose: true, timing: true, notes: false, unlocked: false
    },
    {
      id: 13, name: 'Experto IV', desc: '4 medicamentos, muchas opciones',
      medCount: 4, viewTime: 8, optionCount: 10, mechanic: 'full-config',
      splitDose: true, timing: true, notes: false, unlocked: false
    },
    {
      id: 14, name: 'Maestro I', desc: '5 medicamentos introduccion',
      medCount: 5, viewTime: 10, optionCount: 10, mechanic: 'full-config',
      splitDose: true, timing: true, notes: false, unlocked: false
    },
    {
      id: 15, name: 'Maestro II', desc: '5 medicamentos con notas',
      medCount: 5, viewTime: 9, optionCount: 11, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 103, name: 'Bonus: Cuenta Gotas', desc: 'Dosis exacta con cuentagotas, 2 medicamentos',
      medCount: 2, viewTime: 12, optionCount: 0, mechanic: 'full-config',
      splitDose: false, timing: false, notes: false, unlocked: false,
      type: 'bonus', bonusType: 'count-drops'
    },
    {
      id: 16, name: 'Maestro III', desc: '5 medicamentos, tiempo reducido',
      medCount: 5, viewTime: 8, optionCount: 11, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 17, name: 'Maestro IV', desc: '5 medicamentos, muchos distractores',
      medCount: 5, viewTime: 8, optionCount: 12, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 18, name: 'Elite I', desc: '6 medicamentos introduccion',
      medCount: 6, viewTime: 10, optionCount: 12, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 19, name: 'Elite II', desc: '6 medicamentos, tiempo ajustado',
      medCount: 6, viewTime: 8, optionCount: 12, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 20, name: 'Gran Maestro', desc: '6 medicamentos, desafio completo',
      medCount: 6, viewTime: 7, optionCount: 12, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    },
    {
      id: 21, name: 'Farmaceutico', desc: '7 medicamentos, el desafio final',
      medCount: 7, viewTime: 7, optionCount: 12, mechanic: 'full-config',
      splitDose: true, timing: true, notes: true, unlocked: false
    }
  ];

  // Helper: get level by ID (since bonus levels use non-sequential IDs)
  function getLevelById(id) { return LEVELS.find(l => l.id === id); }
  function getLevelIndex(id) { return LEVELS.findIndex(l => l.id === id); }

  // ==================== STATE ====================
  let state = {
    currentLevel: null,
    prescription: [],      // array of {name, dosage, form, category, quantity, frequency, note?}
    deskOptions: [],        // array of {name, dosage, form, category, id}
    selectedMeds: [],       // array of {id, name, dosage, form, quantity, frequency}
    score: 0,
    gameSessionId: null,
    startTime: null,
    prescriptionShownAt: null,
    deskShownAt: null,
    bestScores: {},
    countdownTimer: null,
    responseTimer: null,
    responseSeconds: 0
  };

  // ==================== CLINICAL BIOMARKERS (Digital Phenotyping) ====================
  // For cognitive assessment - memory, processing speed, adherence simulation
  let clinicalMetrics = {
    // Memory Span - how many items correctly recalled
    memorySpanAttempts: [],      // Track across sessions: max items remembered
    currentMemorySpan: 0,         // Current session memory span

    // Processing Speed - decision timing
    selectionTimes: [],           // Time (ms) to select each medication
    firstSelectionTime: 0,        // Time to first action
    lastSelectionTime: 0,         // Timestamp of last selection

    // Hesitation/Decision patterns
    selectionChanges: 0,          // How many times user changed their selection (deselected)
    configurationChanges: 0,      // How many times user changed dose/frequency

    // Errors breakdown (for cognitive analysis)
    omissionErrors: 0,            // Medications missed (not selected)
    commissionErrors: 0,          // Wrong medications selected
    dosageErrors: 0,              // Correct medication, wrong dosage
    frequencyErrors: 0,           // Correct medication, wrong frequency

    // Simulated Medication Possession Ratio (adherence proxy)
    // Based on selecting correct meds at correct dose/frequency
    simulatedMPR: 0,

    // Time analysis
    viewingDuration: 0,           // Actual time spent viewing prescription
    decisionDuration: 0,          // Time spent in desk phase

    // Session tracking
    sessionAttempts: 0,           // How many times this level was attempted
    inputMethod: 'unknown'        // mouse/touch
  };

  function resetClinicalMetrics() {
    clinicalMetrics = {
      memorySpanAttempts: clinicalMetrics.memorySpanAttempts || [],
      currentMemorySpan: 0,
      selectionTimes: [],
      firstSelectionTime: 0,
      lastSelectionTime: 0,
      selectionChanges: 0,
      configurationChanges: 0,
      omissionErrors: 0,
      commissionErrors: 0,
      dosageErrors: 0,
      frequencyErrors: 0,
      simulatedMPR: 0,
      viewingDuration: 0,
      decisionDuration: 0,
      sessionAttempts: (clinicalMetrics.sessionAttempts || 0) + 1,
      inputMethod: clinicalMetrics.inputMethod || 'unknown'
    };
  }

  // Record selection timing
  function recordSelection(isSelect) {
    const now = Date.now();
    if (state.deskShownAt) {
      const timeSinceDeskShown = now - state.deskShownAt;
      clinicalMetrics.selectionTimes.push(timeSinceDeskShown);

      if (clinicalMetrics.firstSelectionTime === 0) {
        clinicalMetrics.firstSelectionTime = timeSinceDeskShown;
      }
      clinicalMetrics.lastSelectionTime = now;
    }

    if (!isSelect) {
      clinicalMetrics.selectionChanges++;
    }
  }

  // Record configuration changes (dose/frequency)
  function recordConfigChange() {
    clinicalMetrics.configurationChanges++;
  }

  // Record input method
  function recordInputMethod(method) {
    if (clinicalMetrics.inputMethod === 'unknown') {
      clinicalMetrics.inputMethod = method;
    }
  }

  // Calculate clinical statistics after evaluation
  function calculateClinicalStats(results) {
    const totalMeds = results.totalMeds;
    const correctMeds = results.correctMeds;
    const deskPhaseMs = state.deskShownAt ? (Date.now() - state.deskShownAt) : 0;
    const viewPhaseMs = state.prescriptionShownAt && state.deskShownAt
      ? (state.deskShownAt - state.prescriptionShownAt)
      : (state.currentLevel?.viewTime || 0) * 1000;

    // Calculate memory span (max items correctly identified)
    clinicalMetrics.currentMemorySpan = correctMeds;
    clinicalMetrics.memorySpanAttempts.push(correctMeds);

    // Processing speed statistics
    let meanSelectionTime = 0;
    let selectionTimeVariability = 0;
    if (clinicalMetrics.selectionTimes.length > 0) {
      const times = clinicalMetrics.selectionTimes;
      const sum = times.reduce((a, b) => a + b, 0);
      meanSelectionTime = sum / times.length;

      if (times.length > 1) {
        const squaredDiffs = times.map(t => Math.pow(t - meanSelectionTime, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / times.length;
        selectionTimeVariability = Math.sqrt(variance);
      }
    }

    // Simulated MPR (Medication Possession Ratio)
    // Perfect selection = 1.0, decreases with errors
    let mprScore = 0;
    if (totalMeds > 0) {
      // Each correct medication at correct dose/frequency = full point
      // Correct medication wrong config = partial point
      // Missing or wrong medication = 0
      // Based on breakdown: correctMeds gives us correct identification
      // We need to count dose/frequency matches from results
      const perfectMatches = results.allPerfect ? totalMeds : 0;
      const partialMatches = correctMeds - perfectMatches;
      mprScore = (perfectMatches + (partialMatches * 0.5)) / totalMeds;
    }
    clinicalMetrics.simulatedMPR = mprScore;

    // Record timing
    clinicalMetrics.viewingDuration = viewPhaseMs;
    clinicalMetrics.decisionDuration = deskPhaseMs;

    return {
      session_summary: {
        total_duration_sec: Math.round((Date.now() - state.startTime) / 1000),
        accuracy_percentage: totalMeds > 0 ? Math.round((correctMeds / totalMeds) * 100) : 0,
        level_reached: state.currentLevel?.id || 1
      },
      clinical_markers: {
        // Memory Span (key cognitive marker)
        memory_span: clinicalMetrics.currentMemorySpan,
        max_memory_span_historical: Math.max(...clinicalMetrics.memorySpanAttempts, 0),
        memory_span_ratio: totalMeds > 0 ? (clinicalMetrics.currentMemorySpan / totalMeds) : 0,

        // Processing Speed (decision time)
        mean_decision_time_ms: Math.round(meanSelectionTime),
        decision_time_variability_sd: Math.round(selectionTimeVariability),
        time_to_first_selection_ms: clinicalMetrics.firstSelectionTime,

        // Simulated Adherence (MPR proxy)
        simulated_mpr: Math.round(clinicalMetrics.simulatedMPR * 100) / 100,
        adherence_classification: clinicalMetrics.simulatedMPR >= 0.8 ? 'adherent' :
                                  clinicalMetrics.simulatedMPR >= 0.5 ? 'partial' : 'non_adherent',

        // Error Analysis
        omission_errors: results.missedMeds,       // Medications not selected
        commission_errors: results.wrongMeds,      // Wrong medications selected
        total_errors: results.missedMeds + results.wrongMeds,
        error_rate: totalMeds > 0 ? ((results.missedMeds + results.wrongMeds) / (totalMeds + results.wrongMeds)) : 0,

        // Decision Quality (hesitation/uncertainty markers)
        selection_changes: clinicalMetrics.selectionChanges,
        configuration_changes: clinicalMetrics.configurationChanges,
        decisiveness_score: clinicalMetrics.selectionChanges + clinicalMetrics.configurationChanges === 0 ? 1.0 :
          1.0 / (1 + (clinicalMetrics.selectionChanges + clinicalMetrics.configurationChanges) * 0.1),

        // Cognitive Load indicators
        viewing_time_ms: clinicalMetrics.viewingDuration,
        decision_time_ms: clinicalMetrics.decisionDuration,
        time_pressure_factor: state.currentLevel?.viewTime || 0
      },
      device_context: {
        input_method: clinicalMetrics.inputMethod,
        session_restarts: clinicalMetrics.sessionAttempts - 1
      }
    };
  }

  // Load best scores and unlock state
  function loadProgress() {
    try {
      const saved = localStorage.getItem('medmemory_progress');
      if (saved) {
        const data = JSON.parse(saved);
        state.bestScores = data.bestScores || {};
        if (data.unlockedLevels) {
          data.unlockedLevels.forEach(id => {
            const lvl = getLevelById(id);
            if (lvl) lvl.unlocked = true;
          });
        }
      }
    } catch(e) {}
    // Level 1 always unlocked
    LEVELS[0].unlocked = true;
  }

  function saveProgress() {
    try {
      const unlockedLevels = LEVELS.filter(l => l.unlocked).map(l => l.id);
      localStorage.setItem('medmemory_progress', JSON.stringify({
        bestScores: state.bestScores,
        unlockedLevels
      }));
    } catch(e) {}
  }

  // ==================== SESSION HISTORY (for trend charts) ====================
  let metricsHistory = [];
  try {
    metricsHistory = JSON.parse(localStorage.getItem('medmemory_metrics_history') || '[]');
  } catch(e) { metricsHistory = []; }

  function saveMetricsToHistory(levelId, clinicalStats, results) {
    const entry = {
      timestamp: Date.now(),
      date: new Date().toISOString(),
      level: levelId,
      duration_sec: clinicalStats.session_summary.total_duration_sec,
      accuracy: clinicalStats.session_summary.accuracy_percentage,
      score: results.score,
      max_score: results.maxScore,
      star_count: results.score / results.maxScore >= 0.95 ? 5 :
                  results.score / results.maxScore >= 0.75 ? 4 :
                  results.score / results.maxScore >= 0.5 ? 3 :
                  results.score / results.maxScore >= 0.25 ? 2 : 1,
      memory_span: clinicalStats.clinical_markers.memory_span,
      mean_decision_time_ms: clinicalStats.clinical_markers.mean_decision_time_ms,
      decision_variability_sd: clinicalStats.clinical_markers.decision_time_variability_sd,
      simulated_mpr: clinicalStats.clinical_markers.simulated_mpr,
      omission_errors: clinicalStats.clinical_markers.omission_errors,
      commission_errors: clinicalStats.clinical_markers.commission_errors,
      selection_changes: clinicalStats.clinical_markers.selection_changes
    };
    metricsHistory.push(entry);
    if (metricsHistory.length > 200) metricsHistory = metricsHistory.slice(-200);
    try {
      localStorage.setItem('medmemory_metrics_history', JSON.stringify(metricsHistory));
    } catch(e) {}
  }

  // ==================== INTRA-SESSION TIME SERIES ====================
  let metricsTimeSeries = {
    timestamps: [],
    cumulativeSelections: [],
    cumulativeDeselections: [],
    cumulativeConfigChanges: []
  };
  let timeSeriesInterval = null;

  function resetTimeSeries() {
    metricsTimeSeries = {
      timestamps: [], cumulativeSelections: [],
      cumulativeDeselections: [], cumulativeConfigChanges: []
    };
    if (timeSeriesInterval) { clearInterval(timeSeriesInterval); timeSeriesInterval = null; }
  }

  function recordTimeSeriesPoint() {
    if (!state.deskShownAt) return;
    const elapsed = Math.floor((Date.now() - state.deskShownAt) / 1000);
    metricsTimeSeries.timestamps.push(elapsed);
    metricsTimeSeries.cumulativeSelections.push(clinicalMetrics.selectionTimes.length);
    metricsTimeSeries.cumulativeDeselections.push(clinicalMetrics.selectionChanges);
    metricsTimeSeries.cumulativeConfigChanges.push(clinicalMetrics.configurationChanges);
  }

  // ==================== API ====================
  const token = new URLSearchParams(window.location.search).get('token');
  const isDemoMode = new URLSearchParams(window.location.search).get('demo') === 'true';

  // Show demo badge if in demo mode
  if (isDemoMode) {
    document.getElementById('demoBadge').style.display = 'inline';
    document.getElementById('backBtn').href = '/hdd/admin';
  }

  async function apiCall(body) {
    if (!token) return null;
    try {
      const res = await fetch('/api/hdd/games', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(body)
      });
      if (res.ok) return await res.json();
    } catch(e) {}
    return null;
  }

  async function startSession(level) {
    const result = await apiCall({
      action: 'start_session',
      gameSlug: 'medication-memory',
      level: level
    });
    if (result && result.sessionId) {
      state.gameSessionId = result.sessionId;
    }
  }

  async function saveResult(score, maxScore, durationSeconds, completed, metrics) {
    await apiCall({
      action: 'save_result',
      gameSessionId: state.gameSessionId,
      score, maxScore, durationSeconds, completed, metrics
    });
  }

  // ==================== DOM HELPERS ====================
  function $(id) { return document.getElementById(id); }
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    $(id).classList.add('active');
  }

  function showHeaderStats(show) {
    $('levelBadge').style.display = show ? '' : 'none';
    $('scoreBadge').style.display = show ? '' : 'none';
    $('timerBadge').style.display = show ? '' : 'none';
  }

  // ==================== PRESCRIPTION GENERATION ====================
  function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generatePrescription(levelId) {
    const lvl = getLevelById(levelId);
    const available = shuffle([...MEDICATIONS]);
    const chosen = available.slice(0, lvl.medCount);
    const prescription = [];

    chosen.forEach((med, idx) => {
      const dosage = pickRandom(med.dosages);
      let quantity, frequency;

      if (lvl.splitDose && idx > 0) {
        // possibly use split dose
        const splitOptions = [
          { quantity: '1/2', frequency: 'maniana-noche' },
          { quantity: '1', frequency: 'maniana-noche' },
          { quantity: '1/2', frequency: 'maniana' },
        ];
        if (Math.random() > 0.4) {
          const split = pickRandom(splitOptions);
          quantity = split.quantity;
          frequency = split.frequency;
        } else {
          quantity = pickRandom(['1', '1/2', '2']);
          frequency = pickRandom(['maniana', 'noche', 'mediodia']);
        }
      } else if (lvl.timing && idx >= 2) {
        quantity = pickRandom(['1', '1/2', '1+1/2']);
        frequency = pickRandom(['con-comida', 'en-ayunas', 'maniana', 'noche']);
      } else {
        quantity = pickRandom(['1', '2', '1/2']);
        frequency = pickRandom(['maniana', 'noche', 'maniana-noche']);
      }

      let note = null;
      if (lvl.notes && idx === 0) {
        note = pickRandom(NOTES_POOL);
      }

      prescription.push({
        name: med.name,
        dosage,
        form: med.form,
        category: med.category,
        quantity,
        frequency,
        note
      });
    });

    return prescription;
  }

  function generateDeskOptions(prescription, totalOptions) {
    const mechanic = state.currentLevel?.mechanic || 'full-config';
    const options = [];
    let idCounter = 0;

    // Add correct medications
    prescription.forEach(med => {
      options.push({
        id: idCounter++,
        name: med.name,
        dosage: med.dosage,
        form: med.form,
        category: med.category,
        isCorrect: true
      });
    });

    // For name-and-dose: prioritize same-name distractors with wrong dosages
    if (mechanic === 'name-and-dose') {
      prescription.forEach(med => {
        const medDef = MEDICATIONS.find(m => m.name === med.name);
        if (!medDef) return;
        const otherDosages = medDef.dosages.filter(d => d !== med.dosage);
        otherDosages.forEach(d => {
          if (options.length >= totalOptions) return;
          options.push({
            id: idCounter++,
            name: med.name,
            dosage: d,
            form: med.form,
            category: med.category,
            isCorrect: false
          });
        });
      });
    }

    // Add distractors from different medications
    const usedNames = new Set(prescription.map(m => m.name));
    const availableDistractors = MEDICATIONS.filter(m => !usedNames.has(m.name));
    const shuffledDistractors = shuffle(availableDistractors);

    let dIdx = 0;
    while (options.length < totalOptions && dIdx < shuffledDistractors.length) {
      const med = shuffledDistractors[dIdx];
      const dosage = pickRandom(med.dosages);
      options.push({
        id: idCounter++,
        name: med.name,
        dosage,
        form: med.form,
        category: med.category,
        isCorrect: false
      });
      dIdx++;
    }

    // If we still need more, add same meds with different dosages
    if (options.length < totalOptions) {
      prescription.forEach(med => {
        if (options.length >= totalOptions) return;
        const otherDosages = MEDICATIONS.find(m => m.name === med.name)
          .dosages.filter(d => d !== med.dosage && !options.some(o => o.name === med.name && o.dosage === d));
        if (otherDosages.length > 0) {
          options.push({
            id: idCounter++,
            name: med.name,
            dosage: pickRandom(otherDosages),
            form: med.form,
            category: med.category,
            isCorrect: false
          });
        }
      });
    }

    return shuffle(options);
  }

  // ==================== RENDER FUNCTIONS ====================

  function renderFrequencyText(freq) {
    const map = {
      'maniana': '1 vez por dia (maniana)',
      'mediodia': '1 vez por dia (mediodia)',
      'noche': '1 vez por dia (noche)',
      'maniana-noche': '2 veces por dia (maniana y noche)',
      'maniana-mediodia-noche': '3 veces por dia',
      'con-comida': 'con comida',
      'en-ayunas': 'en ayunas'
    };
    return map[freq] || freq;
  }

  function renderQuantityText(qty) {
    const map = {
      '1/4': '1/4 comprimido',
      '1/2': '1/2 comprimido',
      '1': '1 comprimido',
      '1+1/2': '1 y 1/2 comprimidos',
      '2': '2 comprimidos'
    };
    return map[qty] || qty;
  }

  function renderPrescriptionText(med) {
    let text = `${med.name} ${med.dosage}`;
    text += ` - ${renderQuantityText(med.quantity)} - ${renderFrequencyText(med.frequency)}`;
    return text;
  }

  function renderLevelSelect() {
    loadProgress();
    const grid = $('levelsGrid');
    grid.innerHTML = '';

    const levelColors = ['#10b981','#2563eb','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#84cc16'];

    LEVELS.forEach((lvl, idx) => {
      const card = document.createElement('div');
      const isBonus = lvl.type === 'bonus';
      card.className = 'level-card' + (lvl.unlocked ? '' : ' locked') + (isBonus ? ' bonus-card' : '');
      const best = state.bestScores[lvl.id];
      const color = isBonus ? '#f59e0b' : levelColors[idx % levelColors.length];
      const displayNum = isBonus ? (lvl.bonusType === 'drag-pills' ? '&#9733;' : '&#128167;') : lvl.id;
      card.innerHTML = `
        <div class="level-number" style="background:${color}">${displayNum}</div>
        <div class="level-name">${lvl.name}</div>
        <div class="level-desc">${lvl.desc}</div>
        ${!isBonus ? `<div class="level-meta">
          <span><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> ${lvl.viewTime}s</span>
          <span><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg> ${lvl.optionCount}</span>
        </div>` : '<div class="level-meta"><span>Motor skill</span></div>'}
        ${best !== undefined ? `<div class="level-best">Mejor: ${best} pts</div>` : ''}
      `;
      if (lvl.unlocked) {
        card.addEventListener('click', () => startGame(lvl.id));
      }
      grid.appendChild(card);
    });
  }

  function renderPrescription() {
    const doctor = pickRandom(DOCTOR_NAMES);
    const mat = (10000 + Math.floor(Math.random() * 90000));
    const today = new Date();
    const dateStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;

    $('rxDoctor').textContent = doctor;
    $('rxMat').textContent = `Mat. ${mat} - M.N.`;
    $('rxDate').textContent = `Fecha: ${dateStr}`;
    $('rxSigName').textContent = doctor.replace('Dra. ', '').replace('Dr. ', '');

    const itemsList = $('rxItems');
    itemsList.innerHTML = '';

    state.prescription.forEach((med, idx) => {
      const li = document.createElement('li');
      li.className = 'rx-item';
      let html = `<span class="med-name-rx">${idx + 1}. ${med.name} ${med.dosage}</span><br>`;
      html += `<span class="med-dose-rx">${renderQuantityText(med.quantity)} - ${renderFrequencyText(med.frequency)}</span>`;
      if (med.note) {
        html += `<span class="med-note">Nota: ${med.note}</span>`;
      }
      li.innerHTML = html;
      itemsList.appendChild(li);
    });

    // Reset paper animation
    $('prescriptionPaper').classList.remove('fade-out');
  }

  function renderDeskGrid() {
    const grid = $('medGrid');
    grid.innerHTML = '';

    state.deskOptions.forEach(opt => {
      const card = document.createElement('div');
      card.className = 'med-card';
      card.dataset.id = opt.id;

      const catClass = 'cat-' + opt.category;
      const catLabels = {
        antipsicotico: 'Antipsicotico',
        ansiolitico: 'Ansiolitico',
        antidepresivo: 'Antidepresivo',
        estabilizador: 'Estabilizador',
        anticolinergico: 'Anticolinergico',
        otro: 'Otro'
      };

      card.innerHTML = `
        <div class="med-card-header ${catClass}">
          <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 1.5l3 3-9 9-3-3a4.243 4.243 0 010-6l3-3a4.243 4.243 0 016 0z"/><path d="M13.5 6.5l3 3"/><path d="M14 22h7"/><path d="M17.5 18.5v7"/></svg>
          ${catLabels[opt.category] || 'Otro'}
        </div>
        <div class="med-card-body">
          <div class="med-card-name">${opt.name}</div>
          <div class="med-card-dosage">${opt.dosage}</div>
          <div class="med-card-form">${opt.form}</div>
        </div>
        <div class="med-card-check">&#10003;</div>
      `;

      card.addEventListener('click', () => {
        recordInputMethod('mouse');
        toggleMedSelection(opt);
      });
      card.addEventListener('touchend', (e) => {
        e.preventDefault();
        recordInputMethod('touch');
        toggleMedSelection(opt);
      });
      grid.appendChild(card);
    });
  }

  function toggleMedSelection(opt) {
    const existing = state.selectedMeds.findIndex(m => m.id === opt.id);
    if (existing >= 0) {
      // Deselect
      recordSelection(false); // Track deselection as change
      state.selectedMeds.splice(existing, 1);
      document.querySelector(`.med-card[data-id="${opt.id}"]`).classList.remove('selected');
    } else {
      // Select
      recordSelection(true);
      state.selectedMeds.push({
        id: opt.id,
        name: opt.name,
        dosage: opt.dosage,
        form: opt.form,
        quantity: '1',
        frequency: 'maniana'
      });
      document.querySelector(`.med-card[data-id="${opt.id}"]`).classList.add('selected');
    }
    renderTray();
    updateConfirmButton();
  }

  function renderTray() {
    const trayItems = $('trayItems');
    const trayEmpty = $('trayEmpty');

    if (state.selectedMeds.length === 0) {
      trayEmpty.style.display = '';
      trayItems.innerHTML = '';
      return;
    }

    trayEmpty.style.display = 'none';
    trayItems.innerHTML = '';

    state.selectedMeds.forEach((med, idx) => {
      const item = document.createElement('div');
      item.className = 'tray-item';

      // Build quantity options
      let qtyOptions = QUANTITIES.map(q =>
        `<option value="${q.value}" ${med.quantity === q.value ? 'selected' : ''}>${q.label}</option>`
      ).join('');

      // Build frequency options
      let freqOptions = FREQUENCIES.map(f =>
        `<option value="${f.value}" ${med.frequency === f.value ? 'selected' : ''}>${f.label}</option>`
      ).join('');

      item.innerHTML = `
        <div>
          <div class="tray-item-name">${med.name}</div>
          <div class="tray-item-dosage-label">${med.dosage} - ${med.form}</div>
        </div>
        <div class="tray-item-config">
          <div class="config-group">
            <label>Cantidad</label>
            <select data-idx="${idx}" data-field="quantity">${qtyOptions}</select>
          </div>
          <div class="config-group">
            <label>Frecuencia</label>
            <select data-idx="${idx}" data-field="frequency">${freqOptions}</select>
          </div>
        </div>
        <button class="tray-item-remove" data-id="${med.id}" title="Quitar">&times;</button>
      `;

      // Bind events
      item.querySelector('.tray-item-remove').addEventListener('click', (e) => {
        e.stopPropagation();
        const id = parseInt(e.currentTarget.dataset.id);
        const opt = state.deskOptions.find(o => o.id === id);
        if (opt) toggleMedSelection(opt);
      });

      item.querySelectorAll('select').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const i = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          state.selectedMeds[i][field] = e.target.value;
          recordConfigChange(); // Track configuration changes
        });
      });

      trayItems.appendChild(item);
    });
  }

  function updateConfirmButton() {
    $('confirmBtn').disabled = state.selectedMeds.length === 0;
  }

  // ==================== GAME FLOW ====================

  async function startGame(levelId) {
    const lvl = getLevelById(levelId);
    if (!lvl) return;
    state.currentLevel = lvl;
    state.score = 0;
    state.selectedMeds = [];
    state.responseSeconds = 0;
    state.startTime = Date.now();

    // Reset clinical metrics for new session
    resetClinicalMetrics();
    resetTimeSeries();

    $('levelValue').textContent = lvl.type === 'bonus' ? 'B' : levelId;
    $('scoreValue').textContent = '0';
    showHeaderStats(true);

    // For bonus levels, generate prescription but skip desk phase
    if (lvl.type === 'bonus') {
      state.prescription = generatePrescription(levelId);
      await startSession(levelId);
      renderPrescription();
      showScreen('screenPrescription');
      startCountdown(lvl.viewTime);
      return;
    }

    // Generate prescription and desk
    state.prescription = generatePrescription(levelId);
    state.deskOptions = generateDeskOptions(state.prescription, lvl.optionCount);

    // API
    await startSession(levelId);

    // Show prescription
    renderPrescription();
    showScreen('screenPrescription');

    // Start countdown
    startCountdown(lvl.viewTime);
  }

  function startCountdown(seconds) {
    const circumference = 2 * Math.PI * 35; // r=35
    const progress = $('countdownProgress');
    const text = $('countdownText');
    const badge = $('timerBadge');
    let remaining = seconds;

    progress.style.strokeDasharray = circumference;
    progress.style.strokeDashoffset = '0';
    text.textContent = remaining;
    $('timerValue').textContent = remaining + 's';
    badge.className = 'stat-badge timer';
    state.prescriptionShownAt = Date.now();

    state.countdownTimer = setInterval(() => {
      remaining--;
      const offset = circumference * (1 - remaining / seconds);
      progress.style.strokeDashoffset = offset;
      text.textContent = remaining;
      $('timerValue').textContent = remaining + 's';

      if (remaining <= 3) {
        progress.style.stroke = '#ef4444';
        text.style.color = '#ef4444';
        badge.className = 'stat-badge timer critical';
      } else if (remaining <= 5) {
        progress.style.stroke = '#f59e0b';
        text.style.color = '#f59e0b';
        badge.className = 'stat-badge timer warning';
      } else {
        progress.style.stroke = '#2563eb';
        text.style.color = '#2563eb';
        badge.className = 'stat-badge timer';
      }

      if (remaining <= 0) {
        clearInterval(state.countdownTimer);
        endPrescriptionPhase();
      }
    }, 1000);
  }

  function endPrescriptionPhase() {
    $('prescriptionPaper').classList.add('fade-out');

    // Insert psychoeducation tip into transition screen
    const tipText = getPsychoeduTip(state.currentLevel.id);
    const tipDiv = $('transitionTip');
    if (tipText) {
      tipDiv.innerHTML = `<div class="psychoedu-tip"><span class="tip-icon">&#128161;</span><span class="tip-text">${tipText}</span></div>`;
    } else {
      tipDiv.innerHTML = '';
    }

    // Update transition text for bonus levels
    if (state.currentLevel.type === 'bonus') {
      $('screenTransition').querySelector('.transition-text').textContent =
        state.currentLevel.bonusType === 'drag-pills' ? 'Armá el pastillero' : 'Contá las gotas';
      $('screenTransition').querySelector('.transition-sub').textContent =
        state.currentLevel.bonusType === 'drag-pills'
          ? 'Arrastrá cada pastilla al compartimiento correcto'
          : 'Tocá el frasco para dosificar la cantidad correcta';
    } else {
      $('screenTransition').querySelector('.transition-text').textContent = 'Armá tu medicacion del dia';
      $('screenTransition').querySelector('.transition-sub').textContent =
        'Seleccioná los medicamentos correctos y configurá las dosis';
    }

    setTimeout(() => {
      showScreen('screenTransition');

      setTimeout(() => {
        if (state.currentLevel.type === 'bonus') {
          startBonusLevel();
        } else {
          showDeskPhase();
        }
      }, 1800);
    }, 600);
  }

  function showDeskPhase() {
    state.deskShownAt = Date.now();
    state.selectedMeds = [];

    const mechanic = state.currentLevel?.mechanic || 'full-config';

    // For name-only, update instruction and hide tray
    if (mechanic === 'name-only') {
      $('screenDesk').querySelector('.desk-instruction').textContent =
        'Seleccioná solo los medicamentos que estaban en la receta.';
      document.querySelector('.tray-section').style.display = 'none';
    } else if (mechanic === 'name-and-dose') {
      $('screenDesk').querySelector('.desk-instruction').textContent =
        'Seleccioná los medicamentos con la dosis correcta de la receta.';
      document.querySelector('.tray-section').style.display = 'none';
    } else {
      $('screenDesk').querySelector('.desk-instruction').textContent =
        'Seleccioná los medicamentos de la receta y configurá las dosis correctas.';
      document.querySelector('.tray-section').style.display = '';
    }

    renderDeskGrid();
    renderTray();
    updateConfirmButton();
    showScreen('screenDesk');

    // Start response timer
    state.responseSeconds = 0;
    $('timerValue').textContent = '0s';
    $('timerBadge').className = 'stat-badge timer';

    state.responseTimer = setInterval(() => {
      state.responseSeconds++;
      $('timerValue').textContent = state.responseSeconds + 's';
    }, 1000);

    // Start intra-session time series recording
    resetTimeSeries();
    timeSeriesInterval = setInterval(recordTimeSeriesPoint, 2000);
  }

  function evaluateResults() {
    clearInterval(state.responseTimer);
    if (timeSeriesInterval) { clearInterval(timeSeriesInterval); timeSeriesInterval = null; }
    recordTimeSeriesPoint(); // final data point

    const mechanic = state.currentLevel?.mechanic || 'full-config';
    const prescription = state.prescription;
    const selected = state.selectedMeds;
    const breakdown = [];
    let totalScore = 0;

    // Map selected by name+dosage for matching
    const selectedMap = new Map();
    selected.forEach(s => {
      selectedMap.set(s.name + '|' + s.dosage, s);
    });

    // For name-only, also match by name alone (dosage doesn't matter)
    const selectedByName = new Map();
    selected.forEach(s => {
      selectedByName.set(s.name, s);
    });

    let correctMeds = 0;
    let wrongMeds = 0;
    let missedMeds = 0;
    const totalMeds = prescription.length;

    // Check each prescribed medication
    prescription.forEach(rx => {
      if (mechanic === 'name-only') {
        // Only check name match
        const sel = selectedByName.get(rx.name);
        if (sel) {
          selectedByName.delete(rx.name);
          correctMeds++;
          totalScore += 200;
          breakdown.push({ type: 'correct', text: `${rx.name} - medicamento correcto`, points: '+200' });
        } else {
          missedMeds++;
          totalScore -= 50;
          breakdown.push({ type: 'missed', text: `${rx.name} - no fue seleccionado`, points: '-50' });
        }
      } else {
        const key = rx.name + '|' + rx.dosage;
        const sel = selectedMap.get(key);
        if (sel) {
          selectedMap.delete(key);
          correctMeds++;
          totalScore += 100;
          breakdown.push({ type: 'correct', text: `${rx.name} ${rx.dosage} - medicamento correcto`, points: '+100' });

          if (mechanic === 'name-and-dose') {
            // Extra points for correct dosage identification
            totalScore += 150;
            breakdown.push({ type: 'correct', text: `${rx.name} - dosis correcta (${rx.dosage})`, points: '+150' });
          } else {
            // full-config: check quantity
            if (sel.quantity === rx.quantity) {
              totalScore += 100;
              breakdown.push({ type: 'correct', text: `${rx.name} - dosis correcta (${renderQuantityText(rx.quantity)})`, points: '+100' });
            } else {
              breakdown.push({ type: 'wrong', text: `${rx.name} - dosis incorrecta (elegiste ${renderQuantityText(sel.quantity)}, era ${renderQuantityText(rx.quantity)})`, points: '+0' });
            }
            // Check frequency
            if (sel.frequency === rx.frequency) {
              totalScore += 50;
              breakdown.push({ type: 'correct', text: `${rx.name} - frecuencia correcta`, points: '+50' });
            } else {
              breakdown.push({ type: 'wrong', text: `${rx.name} - frecuencia incorrecta (era ${renderFrequencyText(rx.frequency)})`, points: '+0' });
            }
          }
        } else {
          // Check if they selected the right name but wrong dose
          const byNameOnly = selected.find(s => s.name === rx.name && !selectedMap.has(s.name + '|' + s.dosage));
          if (byNameOnly && mechanic === 'name-and-dose') {
            correctMeds++;
            totalScore += 50;
            breakdown.push({ type: 'wrong', text: `${rx.name} - dosis incorrecta (elegiste ${byNameOnly.dosage}, era ${rx.dosage})`, points: '+50' });
          } else {
            missedMeds++;
            totalScore -= 50;
            breakdown.push({ type: 'missed', text: `${rx.name} ${rx.dosage} - no fue seleccionado`, points: '-50' });
          }
        }
      }
    });

    // Check wrong selections
    if (mechanic === 'name-only') {
      selectedByName.forEach((sel) => {
        wrongMeds++;
        totalScore -= 75;
        breakdown.push({ type: 'wrong', text: `${sel.name} - no estaba en la receta`, points: '-75' });
      });
    } else {
      selectedMap.forEach((sel) => {
        wrongMeds++;
        totalScore -= 75;
        breakdown.push({ type: 'wrong', text: `${sel.name} ${sel.dosage} - no estaba en la receta`, points: '-75' });
      });
    }

    // Completion bonus
    const allCorrect = correctMeds === totalMeds && wrongMeds === 0 && missedMeds === 0;
    let allPerfect = allCorrect;
    if (allCorrect && mechanic === 'full-config') {
      prescription.forEach(rx => {
        const sel = selected.find(s => s.name === rx.name && s.dosage === rx.dosage);
        if (!sel || sel.quantity !== rx.quantity || sel.frequency !== rx.frequency) {
          allPerfect = false;
        }
      });
    }

    if (allPerfect) {
      const bonus = mechanic === 'name-only' ? 300 : mechanic === 'name-and-dose' ? 400 : 500;
      totalScore += bonus;
      breakdown.push({ type: 'bonus', text: 'Todo perfecto - bonus de completitud', points: '+' + bonus });
    }

    // Speed bonus
    const viewTime = state.currentLevel.viewTime;
    if (state.responseSeconds <= viewTime * 2) {
      const speedBonus = Math.max(0, Math.round(200 - state.responseSeconds * 5));
      if (speedBonus > 0) {
        totalScore += speedBonus;
        breakdown.push({ type: 'bonus', text: `Bonus de velocidad (${state.responseSeconds}s)`, points: '+' + speedBonus });
      }
    }

    totalScore = Math.max(0, totalScore);
    const maxScore = mechanic === 'name-only' ? totalMeds * 200 + 300 + 200 :
                     mechanic === 'name-and-dose' ? totalMeds * 250 + 400 + 200 :
                     totalMeds * 250 + 500 + 200;

    return { score: totalScore, maxScore, breakdown, correctMeds, wrongMeds, missedMeds, totalMeds, allPerfect };
  }

  function showResults(results) {
    const durationSeconds = Math.round((Date.now() - state.startTime) / 1000);
    const viewTimeSeconds = state.currentLevel.viewTime;

    state.score = results.score;
    $('scoreValue').textContent = results.score;

    // Score and stars
    $('resultsScore').textContent = results.score;
    $('resultsMax').textContent = '/ ' + results.maxScore;

    const pct = results.score / results.maxScore;
    const starCount = pct >= 0.95 ? 5 : pct >= 0.75 ? 4 : pct >= 0.5 ? 3 : pct >= 0.25 ? 2 : pct > 0 ? 1 : 0;
    let starsHtml = '';
    for (let i = 0; i < 5; i++) {
      starsHtml += i < starCount
        ? '<span class="star-filled">&#9733;</span>'
        : '<span class="star-empty">&#9733;</span>';
    }
    $('resultsStars').innerHTML = starsHtml;

    // Breakdown
    const list = $('resultsBreakdown');
    list.innerHTML = '';
    results.breakdown.forEach(item => {
      const li = document.createElement('li');
      const iconClass = item.type === 'correct' ? 'correct' :
                        item.type === 'wrong' ? 'wrong' :
                        item.type === 'missed' ? 'missed' : 'bonus';
      const iconSymbol = item.type === 'correct' ? '&#10003;' :
                         item.type === 'wrong' ? '&#10007;' :
                         item.type === 'missed' ? '!' : '&#9733;';
      const pointClass = item.points.startsWith('+') && item.points !== '+0' ? 'positive' :
                         item.points.startsWith('-') ? 'negative' : 'neutral';

      li.innerHTML = `
        <div class="result-icon ${iconClass}">${iconSymbol}</div>
        <div class="result-detail">${item.text}</div>
        <div class="result-points ${pointClass}">${item.points}</div>
      `;
      list.appendChild(li);
    });

    // Psychoeducation feedback
    const psychoeduDiv = $('resultsPsychoedu');
    const feedback = getErrorFeedback(results);
    if (feedback) {
      psychoeduDiv.innerHTML = `<div class="results-psychoedu"><span>&#128218;</span> ${feedback}</div>`;
    } else {
      psychoeduDiv.innerHTML = '';
    }

    // Footer buttons
    const footer = $('resultsFooter');
    footer.innerHTML = '';

    const retryBtn = document.createElement('button');
    retryBtn.className = 'btn-retry';
    retryBtn.textContent = 'Reintentar';
    retryBtn.addEventListener('click', () => {
      $('resultsOverlay').classList.remove('active');
      startGame(state.currentLevel.id);
    });
    footer.appendChild(retryBtn);

    // Unlock next level if score is above 25%
    const currentId = state.currentLevel.id;
    const currentIdx = getLevelIndex(currentId);
    if (pct >= 0.25 && currentIdx < LEVELS.length - 1) {
      const nextLvl = LEVELS[currentIdx + 1];
      if (!nextLvl.unlocked) {
        nextLvl.unlocked = true;
      }
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn-next';
      nextBtn.textContent = 'Siguiente nivel';
      nextBtn.addEventListener('click', () => {
        $('resultsOverlay').classList.remove('active');
        startGame(nextLvl.id);
      });
      footer.appendChild(nextBtn);
    }

    const backBtn = document.createElement('button');
    backBtn.className = 'btn-back-portal';
    backBtn.textContent = 'Volver al menu';
    backBtn.addEventListener('click', () => {
      $('resultsOverlay').classList.remove('active');
      showHeaderStats(false);
      renderLevelSelect();
      showScreen('screenLevelSelect');
    });
    footer.appendChild(backBtn);

    // Save best score
    if (!state.bestScores[currentId] || results.score > state.bestScores[currentId]) {
      state.bestScores[currentId] = results.score;
    }
    saveProgress();

    // Calculate clinical biomarkers
    const clinicalStats = calculateClinicalStats(results);

    // Save session to history for trend charts
    saveMetricsToHistory(currentId, clinicalStats, results);

    // API save
    saveResult(
      results.score,
      results.maxScore,
      durationSeconds,
      results.allPerfect,
      {
        // Legacy metrics
        correctMeds: results.correctMeds,
        wrongMeds: results.wrongMeds,
        missedMeds: results.missedMeds,
        totalMeds: results.totalMeds,
        viewTimeSeconds,
        responseTimeSeconds: state.responseSeconds,
        mechanic: state.currentLevel?.mechanic || 'full-config',

        // Clinical biomarkers (DTx / Digital Phenotyping)
        ...clinicalStats,

        // Intra-session time series
        time_series: metricsTimeSeries
      }
    );

    // Show overlay
    $('resultsOverlay').classList.add('active');
  }

  // ==================== BONUS LEVELS ====================

  let bonusState = {
    type: null,         // 'drag-pills' or 'count-drops'
    pills: [],          // for drag-pills: {name, dosage, frequency, placed: false, slotId: null}
    slots: [],          // for drag-pills: {id, label, time, correctPill: name}
    dropCount: 0,       // for count-drops: current drops
    targetDrops: 0,     // for count-drops: target number
    currentDropMed: 0,  // for count-drops: which med we're dosing
    dropMeds: [],       // for count-drops: [{name, targetDrops}]
    dragData: null       // currently dragged pill element
  };

  function startBonusLevel() {
    state.deskShownAt = Date.now();
    const lvl = state.currentLevel;
    const content = $('bonusContent');
    content.innerHTML = '';

    // Start response timer
    state.responseSeconds = 0;
    $('timerValue').textContent = '0s';
    $('timerBadge').className = 'stat-badge timer';
    state.responseTimer = setInterval(() => {
      state.responseSeconds++;
      $('timerValue').textContent = state.responseSeconds + 's';
    }, 1000);

    if (lvl.bonusType === 'drag-pills') {
      startDragPillsBonus(content);
    } else {
      startCountDropsBonus(content);
    }

    showScreen('screenBonus');
  }

  function startDragPillsBonus(container) {
    $('bonusInstruction').textContent = 'Arrastrá cada pastilla al compartimiento correcto del pastillero';

    const timeSlots = ['Maniana', 'Mediodia', 'Noche'];
    bonusState.type = 'drag-pills';
    bonusState.pills = [];
    bonusState.slots = [];

    // Create slots from prescription
    state.prescription.forEach(med => {
      const freqMap = {
        'maniana': ['Maniana'], 'mediodia': ['Mediodia'], 'noche': ['Noche'],
        'maniana-noche': ['Maniana', 'Noche'], 'maniana-mediodia-noche': ['Maniana', 'Mediodia', 'Noche'],
        'con-comida': ['Mediodia'], 'en-ayunas': ['Maniana']
      };
      const times = freqMap[med.frequency] || ['Maniana'];
      times.forEach(time => {
        const slotId = med.name + '-' + time;
        bonusState.slots.push({ id: slotId, label: med.name.split(' ')[0], time, correctPill: med.name });
        bonusState.pills.push({ name: med.name, dosage: med.dosage, time, placed: false, slotId: null });
      });
    });

    // Render pastillero grid
    const gridHtml = `<div class="pastillero-grid" id="pastilleroGrid">
      ${bonusState.slots.map(s => `
        <div class="pastillero-slot" data-slot-id="${s.id}" data-correct="${s.correctPill}">
          <span class="slot-label">${s.label}</span>
          <span class="slot-time">${s.time}</span>
        </div>
      `).join('')}
    </div>`;

    // Render draggable pills
    const pillColors = ['#7c3aed', '#0891b2', '#059669', '#d97706', '#be185d', '#6366f1', '#ef4444'];
    const pillsHtml = `<div class="drag-pills-area" id="dragPillsArea">
      ${shuffle(bonusState.pills).map((p, i) => `
        <div class="draggable-pill" data-pill-name="${p.name}" data-pill-time="${p.time}"
             style="background:${pillColors[i % pillColors.length]}">
          ${p.name.split(' ')[0]}<br>${p.dosage}
        </div>
      `).join('')}
    </div>`;

    container.innerHTML = gridHtml + pillsHtml;

    // Setup drag handlers
    container.querySelectorAll('.draggable-pill').forEach(pill => {
      pill.addEventListener('mousedown', startDrag);
      pill.addEventListener('touchstart', startDrag, { passive: false });
    });

    $('bonusConfirmBtn').style.display = '';
    $('bonusConfirmBtn').onclick = evaluateDragPillsBonus;
  }

  function startDrag(e) {
    e.preventDefault();
    const pill = e.currentTarget;
    if (pill.classList.contains('placed')) return;

    const rect = pill.getBoundingClientRect();
    const clone = pill.cloneNode(true);
    clone.classList.add('dragging');
    clone.style.left = rect.left + 'px';
    clone.style.top = rect.top + 'px';
    clone.style.width = rect.width + 'px';
    document.body.appendChild(clone);

    bonusState.dragData = { original: pill, clone, name: pill.dataset.pillName, time: pill.dataset.pillTime };
    pill.style.opacity = '0.3';

    const moveHandler = (ev) => {
      ev.preventDefault();
      const x = ev.touches ? ev.touches[0].clientX : ev.clientX;
      const y = ev.touches ? ev.touches[0].clientY : ev.clientY;
      clone.style.left = (x - rect.width / 2) + 'px';
      clone.style.top = (y - 20) + 'px';

      // Highlight drop zones
      document.querySelectorAll('.pastillero-slot').forEach(slot => {
        const sr = slot.getBoundingClientRect();
        if (x >= sr.left && x <= sr.right && y >= sr.top && y <= sr.bottom) {
          slot.classList.add('drag-over');
        } else {
          slot.classList.remove('drag-over');
        }
      });
    };

    const upHandler = (ev) => {
      const x = ev.changedTouches ? ev.changedTouches[0].clientX : ev.clientX;
      const y = ev.changedTouches ? ev.changedTouches[0].clientY : ev.clientY;

      // Check if dropped on a slot
      let dropped = false;
      document.querySelectorAll('.pastillero-slot').forEach(slot => {
        slot.classList.remove('drag-over');
        const sr = slot.getBoundingClientRect();
        if (x >= sr.left && x <= sr.right && y >= sr.top && y <= sr.bottom && !slot.classList.contains('filled')) {
          // Place pill in slot
          slot.classList.add('filled');
          slot.innerHTML += `<span class="slot-pill-name">${pill.dataset.pillName.split(' ')[0]}</span>`;
          slot.dataset.placedPill = pill.dataset.pillName;
          pill.style.display = 'none';
          dropped = true;
        }
      });

      if (!dropped) pill.style.opacity = '1';
      clone.remove();
      bonusState.dragData = null;

      document.removeEventListener('mousemove', moveHandler);
      document.removeEventListener('mouseup', upHandler);
      document.removeEventListener('touchmove', moveHandler);
      document.removeEventListener('touchend', upHandler);
    };

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
    document.addEventListener('touchmove', moveHandler, { passive: false });
    document.addEventListener('touchend', upHandler);
  }

  function evaluateDragPillsBonus() {
    clearInterval(state.responseTimer);
    const breakdown = [];
    let totalScore = 0;
    let correct = 0;
    const total = bonusState.slots.length;

    bonusState.slots.forEach(slot => {
      const el = document.querySelector(`[data-slot-id="${slot.id}"]`);
      const placed = el?.dataset.placedPill;
      if (placed === slot.correctPill) {
        correct++;
        totalScore += 200;
        breakdown.push({ type: 'correct', text: `${slot.label} (${slot.time}) - correcto`, points: '+200' });
      } else if (placed) {
        totalScore -= 100;
        breakdown.push({ type: 'wrong', text: `${slot.label} (${slot.time}) - incorrecto (pusiste ${placed.split(' ')[0]})`, points: '-100' });
      } else {
        totalScore -= 50;
        breakdown.push({ type: 'missed', text: `${slot.label} (${slot.time}) - vacio`, points: '-50' });
      }
    });

    if (correct === total) {
      totalScore += 300;
      breakdown.push({ type: 'bonus', text: 'Pastillero perfecto', points: '+300' });
    }

    totalScore = Math.max(0, totalScore);
    const maxScore = total * 200 + 300;
    const results = {
      score: totalScore, maxScore, breakdown,
      correctMeds: correct, wrongMeds: 0, missedMeds: total - correct,
      totalMeds: total, allPerfect: correct === total
    };
    showResults(results);
  }

  function startCountDropsBonus(container) {
    $('bonusInstruction').textContent = 'Tocá el frasco para agregar gotas. Dosificá la cantidad indicada en la receta.';

    bonusState.type = 'count-drops';
    bonusState.dropCount = 0;
    bonusState.currentDropMed = 0;
    bonusState.dropMeds = state.prescription.map(med => {
      const qtyMap = { '1/4': 5, '1/2': 10, '1': 20, '1+1/2': 30, '2': 40 };
      return { name: med.name, targetDrops: qtyMap[med.quantity] || 20 };
    });

    renderDropsUI(container);
    $('bonusConfirmBtn').style.display = '';
    $('bonusConfirmBtn').onclick = confirmDrops;
  }

  function renderDropsUI(container) {
    const med = bonusState.dropMeds[bonusState.currentDropMed];
    if (!container) container = $('bonusContent');
    container.innerHTML = `
      <div class="drops-area">
        <div class="drops-target-label">Medicamento ${bonusState.currentDropMed + 1}/${bonusState.dropMeds.length}: <strong>${med.name}</strong></div>
        <div class="drops-target-label">Objetivo: <strong>${med.targetDrops} gotas</strong></div>
        <div class="drops-bottle" id="dropsBottle">
          <span class="bottle-label">${med.name.split(' ')[0]}</span>
        </div>
        <div class="drops-counter" id="dropsCounter">${bonusState.dropCount}</div>
        <div class="drops-target">gotas</div>
      </div>
    `;

    $('dropsBottle').addEventListener('click', addDrop);
    $('dropsBottle').addEventListener('touchend', (e) => { e.preventDefault(); addDrop(); });
  }

  function addDrop() {
    bonusState.dropCount++;
    $('dropsCounter').textContent = bonusState.dropCount;

    // Visual drop animation
    const bottle = $('dropsBottle');
    const drop = document.createElement('div');
    drop.className = 'drop-animation';
    drop.style.left = (bottle.offsetWidth / 2 - 6) + 'px';
    bottle.appendChild(drop);
    setTimeout(() => drop.remove(), 500);
  }

  function confirmDrops() {
    const med = bonusState.dropMeds[bonusState.currentDropMed];
    med.actualDrops = bonusState.dropCount;

    bonusState.currentDropMed++;
    bonusState.dropCount = 0;

    if (bonusState.currentDropMed < bonusState.dropMeds.length) {
      renderDropsUI();
    } else {
      evaluateDropsBonus();
    }
  }

  function evaluateDropsBonus() {
    clearInterval(state.responseTimer);
    const breakdown = [];
    let totalScore = 0;
    let perfect = 0;

    bonusState.dropMeds.forEach(med => {
      const diff = Math.abs((med.actualDrops || 0) - med.targetDrops);
      if (diff === 0) {
        perfect++;
        totalScore += 300;
        breakdown.push({ type: 'correct', text: `${med.name} - ${med.targetDrops} gotas exactas`, points: '+300' });
      } else if (diff <= 2) {
        totalScore += 150;
        breakdown.push({ type: 'correct', text: `${med.name} - casi perfecto (${med.actualDrops}/${med.targetDrops})`, points: '+150' });
      } else if (diff <= 5) {
        totalScore += 50;
        breakdown.push({ type: 'wrong', text: `${med.name} - ${med.actualDrops}/${med.targetDrops} gotas (diferencia: ${diff})`, points: '+50' });
      } else {
        breakdown.push({ type: 'wrong', text: `${med.name} - ${med.actualDrops}/${med.targetDrops} gotas (diferencia: ${diff})`, points: '+0' });
      }
    });

    if (perfect === bonusState.dropMeds.length) {
      totalScore += 400;
      breakdown.push({ type: 'bonus', text: 'Todas las dosis perfectas', points: '+400' });
    }

    totalScore = Math.max(0, totalScore);
    const maxScore = bonusState.dropMeds.length * 300 + 400;
    const results = {
      score: totalScore, maxScore, breakdown,
      correctMeds: perfect, wrongMeds: 0, missedMeds: bonusState.dropMeds.length - perfect,
      totalMeds: bonusState.dropMeds.length, allPerfect: perfect === bonusState.dropMeds.length
    };
    showResults(results);
  }

  // ==================== CANVAS CHART DRAWING ====================

  function drawLineChart(canvas, data, options = {}) {
    if (!canvas || !data || data.length === 0) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.offsetWidth * 2;
    const h = canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    const cw = w / 2;
    const ch = h / 2;
    const pad = { top: 10, right: 15, bottom: 25, left: 45 };

    ctx.clearRect(0, 0, cw, ch);

    const plotW = cw - pad.left - pad.right;
    const plotH = ch - pad.top - pad.bottom;

    const vals = data.map(d => d.value);
    let minV = options.minY !== undefined ? options.minY : Math.min(...vals);
    let maxV = options.maxY !== undefined ? options.maxY : Math.max(...vals);
    if (minV === maxV) { minV -= 1; maxV += 1; }

    // Grid lines
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + plotH * (1 - i / 4);
      ctx.beginPath();
      ctx.moveTo(pad.left, y);
      ctx.lineTo(pad.left + plotW, y);
      ctx.stroke();
      ctx.fillStyle = '#94a3b8';
      ctx.font = '9px sans-serif';
      ctx.textAlign = 'right';
      const val = minV + (maxV - minV) * (i / 4);
      ctx.fillText(Math.round(val), pad.left - 4, y + 3);
    }

    // Data line
    ctx.strokeStyle = options.color || '#2563eb';
    ctx.lineWidth = 2;
    ctx.beginPath();
    data.forEach((d, i) => {
      const x = pad.left + (plotW * i / Math.max(data.length - 1, 1));
      const y = pad.top + plotH * (1 - (d.value - minV) / (maxV - minV));
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Data points
    ctx.fillStyle = options.color || '#2563eb';
    data.forEach((d, i) => {
      const x = pad.left + (plotW * i / Math.max(data.length - 1, 1));
      const y = pad.top + plotH * (1 - (d.value - minV) / (maxV - minV));
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    });

    // X axis labels (sparse)
    ctx.fillStyle = '#94a3b8';
    ctx.font = '8px sans-serif';
    ctx.textAlign = 'center';
    const step = Math.max(1, Math.floor(data.length / 6));
    for (let i = 0; i < data.length; i += step) {
      const x = pad.left + (plotW * i / Math.max(data.length - 1, 1));
      ctx.fillText(data[i].label || (i + 1), x, ch - 4);
    }
  }

  function drawGroupedBarChart(canvas, data, options = {}) {
    if (!canvas || !data || data.length === 0) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.offsetWidth * 2;
    const h = canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    const cw = w / 2;
    const ch = h / 2;
    const pad = { top: 10, right: 15, bottom: 25, left: 40 };

    ctx.clearRect(0, 0, cw, ch);

    const plotW = cw - pad.left - pad.right;
    const plotH = ch - pad.top - pad.bottom;

    const colors = options.colors || ['#ef4444', '#f59e0b'];
    const allVals = data.flatMap(d => d.values);
    const maxV = Math.max(...allVals, 1);

    // Grid
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + plotH * (1 - i / 4);
      ctx.beginPath();
      ctx.moveTo(pad.left, y);
      ctx.lineTo(pad.left + plotW, y);
      ctx.stroke();
      ctx.fillStyle = '#94a3b8';
      ctx.font = '9px sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(Math.round(maxV * i / 4), pad.left - 4, y + 3);
    }

    // Bars
    const barGroupW = plotW / data.length;
    const barW = barGroupW / (colors.length + 1);
    data.forEach((d, i) => {
      d.values.forEach((v, j) => {
        const x = pad.left + barGroupW * i + barW * j + barW * 0.3;
        const barH = (v / maxV) * plotH;
        ctx.fillStyle = colors[j];
        ctx.fillRect(x, pad.top + plotH - barH, barW * 0.7, barH);
      });
    });

    // Labels
    ctx.fillStyle = '#94a3b8';
    ctx.font = '8px sans-serif';
    ctx.textAlign = 'center';
    const step = Math.max(1, Math.floor(data.length / 8));
    for (let i = 0; i < data.length; i += step) {
      const x = pad.left + barGroupW * i + barGroupW / 2;
      ctx.fillText(data[i].label || (i + 1), x, ch - 4);
    }

    // Legend
    if (options.legends) {
      ctx.font = '8px sans-serif';
      let lx = pad.left;
      options.legends.forEach((legend, i) => {
        ctx.fillStyle = colors[i];
        ctx.fillRect(lx, 2, 8, 8);
        ctx.fillStyle = '#64748b';
        ctx.fillText(legend, lx + 11, 9);
        lx += ctx.measureText(legend).width + 20;
      });
    }
  }

  // ==================== METRICS PANEL ====================

  function showMetricsPanel() {
    if (metricsHistory.length === 0) {
      alert('Todavia no hay datos de sesiones anteriores. Jugá al menos un nivel para ver tu progreso.');
      return;
    }

    // FDA Summary stats (from latest session)
    const latest = metricsHistory[metricsHistory.length - 1];
    const fdaSummary = $('fdaSummary');
    const metrics = [
      { value: metricsHistory.length, label: 'Sesiones totales' },
      { value: latest.memory_span, label: 'Memoria (ultimo)' },
      { value: Math.max(...metricsHistory.map(h => h.memory_span)), label: 'Memoria (maximo)' },
      { value: latest.mean_decision_time_ms + 'ms', label: 'Velocidad decision' },
      { value: Math.round(latest.simulated_mpr * 100) + '%', label: 'Adherencia (MPR)' },
      { value: latest.accuracy + '%', label: 'Precision (ultima)' },
      { value: Math.round(metricsHistory.reduce((a, h) => a + h.accuracy, 0) / metricsHistory.length) + '%', label: 'Precision (promedio)' },
      { value: latest.omission_errors + latest.commission_errors, label: 'Errores (ultima)' }
    ];
    fdaSummary.innerHTML = metrics.map(m =>
      `<div class="fda-metric"><div class="metric-value">${m.value}</div><div class="metric-label">${m.label}</div></div>`
    ).join('');

    // Draw charts
    const last30 = metricsHistory.slice(-30);

    // Memory span chart
    drawLineChart($('chartMemory'),
      last30.map((h, i) => ({ value: h.memory_span, label: i + 1 })),
      { color: '#2563eb', minY: 0 }
    );

    // Decision speed chart
    drawLineChart($('chartSpeed'),
      last30.map((h, i) => ({ value: h.mean_decision_time_ms, label: i + 1 })),
      { color: '#f59e0b' }
    );

    // MPR chart
    drawLineChart($('chartMPR'),
      last30.map((h, i) => ({ value: h.simulated_mpr, label: i + 1 })),
      { color: '#10b981', minY: 0, maxY: 1.0 }
    );

    // Error breakdown chart
    drawGroupedBarChart($('chartErrors'),
      last30.map((h, i) => ({ values: [h.omission_errors, h.commission_errors], label: i + 1 })),
      { colors: ['#ef4444', '#f59e0b'], legends: ['Omision', 'Comision'] }
    );

    $('metricsOverlay').classList.add('active');
  }

  // ==================== EVENT BINDINGS ====================

  $('confirmBtn').addEventListener('click', () => {
    const results = evaluateResults();
    showResults(results);
  });

  // Metrics panel
  $('showProgressBtn').addEventListener('click', showMetricsPanel);
  $('metricsCloseBtn').addEventListener('click', () => {
    $('metricsOverlay').classList.remove('active');
  });

  // Back button with token preservation
  if (token) {
    $('backBtn').href = '/hdd/portal?token=' + encodeURIComponent(token);
  }

  // ==================== INIT ====================
  loadProgress();
  renderLevelSelect();
  showHeaderStats(false);

})();
</script>

  <!-- Load shared mood modals -->
  <div id="mood-modals-container"></div>
  <script>
    fetch('/games/shared/mood-modals.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('mood-modals-container').innerHTML = html;
      })
      .catch(err => console.error('Failed to load mood modals:', err));
  </script>

</body>
</html>
